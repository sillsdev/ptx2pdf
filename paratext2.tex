%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007 by SIL International
% written by Jonathan Kew
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Paratext formatting macros, spanning footnotes version

\catcode`\@=11
\let\x@=\expandafter

\TeXXeTstate=1 % enable the eTeX bidi extensions, in case we need RTL support

\def\MSG{\immediate\write16 } % shorthand to write a message to the terminal
\def\TRACE#1{} % default - consume messages
%\let\TRACE=\MSG % use this to echo them
\def\wlog{\immediate\write-1 } % write message to log file only

% \addtoendhooks collects macros to be executed at the end of the job
\def\addtoendhooks#1{\x@\global\x@\@ndhooks\x@{\the\@ndhooks #1}}
\newtoks\@ndhooks
\let\s@ve@nd=\end
\def\end{\par\vfill\supereject \the\@ndhooks \s@ve@nd}

% and \addtoinithooks is for stuff we do during one-time-setup before the first PTX file
\def\addtoinithooks#1{\x@\global\x@\@nithooks\x@{\the\@nithooks #1}}
\newtoks\@nithooks

\input ptx-para-style.tex
\input ptx-char-style.tex
\input ptx-note-style.tex
\input ptx-stylesheet.tex % must come after the ptx-*-style.tex macros
\input ptx-references.tex
\input ptx-cropmarks.tex
\input ptx-adj-list.tex % must come after ptx-stylesheet.tex
\input ptx-pic-list.tex % must come after ptx-stylesheet.tex
\input ptx-cutouts.tex
\input ptx-callers.tex % must come after ptx-note-style.tex

% default font names (override in setup file)
\ifx\regular\undefined   \def\regular{"Times New Roman"}      \fi
\ifx\bold\undefined      \def\bold{"Times New Roman/B"}       \fi
\ifx\italic\undefined    \def\italic{"Times New Roman/I"}     \fi
\ifx\bolditalic\undefined\def\bolditalic{"Times New Roman/BI"}\fi

% footnote macros based on plain.tex \footnote, \vfootnote
\def\m@kenote#1#2{\let\@sf\empty % #1=class(e.g. f, x); 
  % #2=caller + all the macros to setup the styling for the caller 
  % text is read later
  \ifhmode\edef\@sf{\spacefactor\the\spacefactor}\/\fi
  % if footnote is on a chapter number ...
  \ifch@pter \everypar={}\ch@pterfalse
    \global\setbox\ch@pternote=\hbox{\box\ch@pternote #2}
  \else #2\fi % output caller
  % @sf preserves the space factor (e.g. extra space after a period), restore it now
  \@sf \vm@kenote{#1}{#2}}

\def\vm@kenote#1#2{%
  \let\next\relax
  \x@\insert\csname note-#1\endcsname\bgroup % insert note-f (or note-x)
%%% single-column notes:
  \checkp@ranotes{#1}% check whether this note class is to be paragraphed 
  % if paragraph notes, make each line infinitely wide so it does not get line broken yet
  \hsize=\ifp@ranotes\maxdimen\else\textwidth\fi
  % insert penalties to control breaking of footnotes
  \interlinepenalty\interfootnotelinepenalty % set penalty to break lines
  \floatingpenalty\@MM % make sure note does not float away from caller to another page
  \leftskip\z@skip \rightskip\z@skip \spaceskip\z@skip \xspaceskip\z@skip % reset extra space around paragraph 0
  \leavevmode % begin paragraph
  \ifRTL\setbox2=\lastbox\beginR\box2\fi % if RTL text this paragraph needs to be RTL
  % if note omitting caller from note (i.e. all callers are *'s)
  \testomitc@ller{#1}\ifomitc@ller\else
    % save copy of caller in temporary box, if non-empty add a little space
    \setbox0=\hbox{#2}#2\ifdim\wd0>0pt\kern.2em\fi
  \fi
  \footstrut % adjust line spacing between notes
  % currently we do not allow footnotes to break to the next page, so this may not be necessary
  \splittopskip\ht\f@@tstrut % top baseline for broken footnotes
  \splitmaxdepth\dp\f@@tstrut
  \futurelet\next\fo@t}% use plain.tex footnote processor

% use \OmitCallerInNote{f} to omit callers from the note at foot of page
% but leave them in the body text (e.g. all the callers are *'s)
\def\OmitCallerInNote#1{%
  \expandafter\let\csname omit-in-note #1\endcsname=1}
%
\def\testomitc@ller#1{\expandafter\ifx\csname omit-in-note #1\endcsname\relax
  \omitc@llerfalse \else \omitc@llertrue \fi}
\newif\ifomitc@ller

% create a "strut" (see TeXbook) of suitable size for the note style
\def\footstrut{\s@tfont{\newn@testyle}%
  \s@tbaseline{\newn@testyle}%
  \setbox\f@@tstrut=\hbox to 0pt{\XeTeXuseglyphmetrics=0 \char32 \hss}%
  \dimen0=\ht\f@@tstrut \dimen2=\dp\f@@tstrut
  \dimen4=\dimen0 \advance\dimen4 by \dimen2
%  \ifdim\dimen4<\baselineskip
    \dimen6=100\baselineskip \divide\dimen6 by \dimen4
    \multiply\dimen0 by \dimen6 \divide\dimen0 by 100
    \multiply\dimen2 by \dimen6 \divide\dimen2 by 100
%  \fi
  \setbox\f@@tstrut=\hbox{}\ht\f@@tstrut=1.2\dimen0 \dp\f@@tstrut=1.2\dimen2
  \copy\f@@tstrut}

\def\@foot{\copy\f@@tstrut \ifp@ranotes \parfillskip=0pt \fi
  \par\egroup}
\newbox\f@@tstrut
\def\n@teglue{2em plus 1em minus .5em\relax} % glue to be used between paragraphed notes

% set baseline appropriately for the given style (may be using much smaller font than body)
% baselineskip = leading
\def\s@tbaseline#1{%
  \x@\ifx\csname baseline<#1>\endcsname \relax
    \getp@ram{fontsize}{#1}\dimen0=\p@ram\le@dingunit
    \multiply\dimen0 by 14 \divide\dimen0 by 12
    \x@\xdef\csname baseline<#1>\endcsname{\the\dimen0}\fi
  \baselineskip=\csname baseline<#1>\endcsname}

% default output routine is single-column, somewhat based on Plain TeX output routine (see TeXbook)
\global\output={\onecol}
\global\holdinginserts=1
\def\onecol{%
  \global\setbox\galley=\copy255
  \global\galleypenalty=\outputpenalty
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \global\output={\onecoltrial}
  \global\holdinginserts=0
  \unvbox255
  \penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi
}
\def\onecoltrial{% single-column version of \twocoltrial (see below)
%%%  \msg{TRIAL with ht=\the\trialheight, vsize=\the\vsize}
  \edef\p@gebotmark{\botmark}% remember last \mark for running header
  \edef\t@st{\p@gefirstmark}%
  \ifx\t@st\empty\edef\p@gefirstmark{\firstmark}\fi % remember first, if not already set
  \availht=\trialheight % amount of space we think is available
  \let\\=\reduceavailht \the\n@tecl@sses % reduce it by the space needed for each note class
  \decr{\availht}{\topins}% and by the space needed for spanning pictures
  \decr{\availht}{\bottomins}
  \setbox\s@vedpage=\copy255
  % split the galley to the actual size available
  \setbox\colA=\vsplit255 to \availht
  \setbox\colA=\vbox{\unvbox\colA}
  % and check if it all fit; if not, we'll have to back up and try again
  \ifvoid255 \fitonpagetrue \else \fitonpagefalse \fi
  \iffitonpage
%%%    \msg{SUCCEEDED, shipping page}
% at this point:
%   \box\colA is the page content
%   \availht is ht that definitely works
    \def\pagecontents{%
      \ifvoid\partial\else \unvbox\partial \fi
      \ifvoid\topins\else \unvbox\topins \vskip\skip\topins \fi
      \dimen0=\dp\colA
      \hbox to \textwidth{\box\colA\hfil}
      \ifvoid\bottomins\else \vskip\skip\bottomins \unvbox\bottomins \fi
      \f@rstnotetrue
      \let\\=\ins@rtn@tecl@ss \the\n@tecl@sses
      \iff@rstnote % no notes actually occurred!
        \kern-\dimen0 \vfil
      \else
        \setbox0=\lastbox \dimen0=\dp0 \box0 \kern-\dimen0
      \fi
    }
    \resetvsize
    \plainoutput
    \xdef\p@gefirstmark{}
    \xdef\p@gebotmark{}
    \global\holdinginserts=1
    \global\output={\onecol}
  \else % the contents of the "galley" didn't fit into the actual page,
        % so reduce \vsize and try again with an earlier break
%%%    \msg{REDUCING VSIZE}
    \global\advance\vsize by -\baselineskip
    \global\setbox\topins=\box\voidb@x
    \global\setbox\bottomins=\box\voidb@x
    \let\\=\cle@rn@tecl@ss \the\n@tecl@sses
    \global\setbox255=\box\voidb@x
    \global\holdinginserts=1
    \global\let\whichtrial=\onecoltrial
    \global\output={\backingup}
    \unvbox\galley \penalty\ifnum\galleypenalty=10000 0 \else \galleypenalty \fi
  \fi}

\def\pagebody{\vbox to\textheight{\boxmaxdepth\maxdepth \pagecontents}}
\def\makeheadline{%
  \vbox to 0pt{\kern-\topm@rgin
   \vbox{\kern\HeaderPosition\MarginUnit
    \setbox0=\hbox to \textwidth{\the\headline}
    \ht0=0pt \dp0=0pt \box0
    \ifrhr@le\ifdim\RHruleposition=\maxdimen\else
      \kern\RHruleposition\hrule
    \fi\fi}\vss}\nointerlineskip}
\newif\ifrhr@le
\def\makefootline{%
  \vbox to 0pt{\kern\bottomm@rgin
    \kern-\FooterPosition\MarginUnit
     \hbox to \textwidth{\the\footline}\vss}}
\newdimen\RHruleposition \RHruleposition=\maxdimen

\def\ins@rtn@tecl@ss#1{% insert the given note class, either paragraphed or separately
  \checkp@ranotes{#1}\ifp@ranotes\let\n@xt=\parains@rtn@tecl@ss
    \else\let\n@xt=\separateins@rtn@tecl@ss\fi
  \n@xt{#1}}

% insert a note class in which each note is on its own line
\def\separateins@rtn@tecl@ss#1{%
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname % make \th@cl@ss be a synonym for the current note class
  % if the noteclass has content to output ...
  \ifvoid\th@cl@ss\else
    \iff@rstnote\kern-\dimen0\vfil\fi % ignore depth of body text; fill space
    \vskip\AboveNoteSpace % output above note class space
    \iff@rstnote\footnoterule\f@rstnotefalse\fi % output rule before first note
    \unvbox\th@cl@ss\fi}% output notes

% insert a note class in which each note is in the same paragraph
\def\parains@rtn@tecl@ss#1{%
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname % make \th@cl@ss be a synonym for the current note class
  % if the noteclass has content to output ...
  \ifvoid\th@cl@ss\else
    \iff@rstnote\kern-\dimen0\vfil\fi % ignore depth of body text; fill space
    \vskip\AboveNoteSpace
    \iff@rstnote\footnoterule\f@rstnotefalse\fi % output rule before first note
    {\maken@tepara{\th@cl@ss}}%
  \fi}

\newif\iff@rstnote
\def\footnoterule{\kern-0.5\AboveNoteSpace\kern-.4pt % the \hrule is .4pt high
  \hrule width \textwidth\kern0.5\AboveNoteSpace}

% determine if a given note class is to be paragraphed
\def\ParagraphedNotes#1{\x@\let\csname paranotes-#1\endcsname=1}
\newif\ifp@ranotes
\def\checkp@ranotes#1{\x@\ifx\csname paranotes-#1\endcsname\relax
  \p@ranotesfalse\else\p@ranotestrue\fi}

% reformat the contents of a note class insertion into a single paragraph.
% this is usually done for \x. It is sometimes done for \f.
% (based on code from the TeXbook, appendix D)
% #1 is vbox containing notes as individual paragraphs.
\def\maken@tepara#1{%
  \hsize=\textwidth % width is full page size
  \let\par=\endgraf\ch@pterfalse
  \everypar={}% don't do body text formatting
  \noindent% don't do body text indenting
  \unvbox#1 % open up the vbox of notes to get at the list of individual note boxes
  \makehboxofhboxes % make a single hbox for all notes of this class
  \setbox0=\hbox{\unhbox0 \removehboxes} % add internote space
  \noindent\unhbox0 % starting making new paragraph
  \unskip\unpenalty\unskip\unskip % remove internote skip info after last note
  % set penalty which allows breaking between notes unless this would cause
  % an extra line to be created.
  \linepenalty50
  \par} 
%
% make box0 = an hbox contining all the contents of this class
\def\makehboxofhboxes{%
  \setbox0=\hbox{}%
  \loop\setbox2=\lastbox \ifhbox2 \setbox0=\hbox{\box2\unhbox0}\repeat} 
%
% remove inside level of boxing and adding inter note space after each
%     [[a][b][c]] --> [a \internotespace b \internotespace c \internotespace]
\def\removehboxes{%
  \setbox0=\lastbox 
  \ifhbox0{\removehboxes}\unhbox0\internotespace\fi}
%
% skip between notes in paragraph. skip is good place to break.
\def\internotespace{\hfil\hskip\intern@teskip\penalty-10\hfilneg}

% don't allow stretching between notes.
\newskip\intern@teskip \intern@teskip=15pt% plus 5pt minus 5pt

% switch to double-column mode if currently single.
% this is called from \parstyle when the new style wants to be double-columned
\def\doublecolumns{%
  \ifnum\c@rrentcols=1
    % make switch from single to double column
    \ifhe@dings\endhe@dings\fi % if headings in process, end headings
    \penalty-100\vskip\baselineskip % ensure blank line between single and double column material
    \global\output={\savepartialpage}\eject % save any partially-full page
	% if single column material already fills 3/4 page, go to next page to start double columns
    \ifdim\ht\partial>0.75\textheight
      \global\output={\onecol} % but output it immediately if 75% full
      \unvbox\partial\vfill\eject
    \fi
    % reset parameters for 2-column formatting
    \global\hsize=\colwidth
    \global\vsize=2\textheight % in 2 col mode you can put twice the height of text
	\global\advance\vsize by -2\ht\partial % subtract height of 1 column material
	\global\advance\vsize by \baselineskip % don't get caught short by 1/2 line or so
	% make a macro reset vsize for remaining pages which do not have 1 column material
    \gdef\resetvsize{\global\vsize=2\textheight \global\advance\vsize by \baselineskip} 
    \global\output={\twocols}
    \global\c@rrentcols=2
    % top and bottom inserts effectively use twice their height
	% (\count of an insertion class is a scaling factor)
    \count255=2000
    \global\count\topins=\count255
    \global\count\bottomins=\count255
    \let\\=\s@tn@tec@unt \the\n@tecl@sses % reset \count for each note class
    \global\holdinginserts=1 % don't pull out inserts yet, we are still adjusting page
  \fi}

% iterate over note classes, set \count for each class  
\def\s@tn@tec@unt#1{%
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname
  \checkp@ranotes{#1}%
  % notes made into paragraphs (e.g. \x) are counted as 0 height for now,
  % later we will backup making page size smaller until things fit
  \global\count\th@cl@ss=\ifp@ranotes 0 \else \count255 \fi
  \global\skip\th@cl@ss=\AboveNoteSpace }

\def\resetvsize{\global\vsize=\textheight} 

\def\msg#1{\immediate\write16{#1}}

\def\savepartialpage{% save a partially-full page when switching to 2-column format,
%%%  \msg{SAVEPARTIAL} % and remember the first \mark on the page
  \edef\t@st{\p@gefirstmark}%
  \ifx\t@st\empty\xdef\p@gefirstmark{\firstmark}\fi
  % save 1 column material since we are switching to 2 columns
  \global\setbox\partial=\vbox{\boxmaxdepth\maxdepth \pagecontents}}
\newbox\partial

\def\twocols{% primary output routine in 2-col mode
%%%  \msg{TWOCOLS @ \ch@pter:\v@rse, txtht=\the\textheight, partial=\the\ht\partial}
  % save copy of current page so we can retry with different heights
  \global\setbox\galley=\copy255
  \global\galleypenalty=\outputpenalty % save current penalty so we can restore it at (A)
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \global\output={\twocoltrial}
  \global\holdinginserts=0 % when doing trial place insertions into boxes
  \unvbox255 % force invoking \twocoltrial
  \penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi % (A) restore output penalty
  }
\newbox\galley
\newcount\galleypenalty
\newdimen\trialheight

% for measuring the space needed for each class of notes;
% this will decrease \availht by the space needed for the given class
\def\reduceavailht#1{%
  \checkp@ranotes{#1}%
  \ifp@ranotes\let\n@xt=\reduceavailht@para
  \else\let\n@xt=\reduceavailht@sep\fi
  \n@xt{#1}}

\def\reduceavailht@para#1{
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname
  \ifvoid\th@cl@ss\else
    \setbox0=\copy\th@cl@ss
    \setbox0=\vbox{\maken@tepara{0}}
    \advance\availht by -\ht0
    \advance\availht by -\dp0
    \advance\availht by -\AboveNoteSpace
  \fi}
\def\reduceavailht@sep#1{
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname
  \ifvoid\th@cl@ss\else
    \advance\availht by -\ht\th@cl@ss
    \advance\availht by -\dp\th@cl@ss
    \advance\availht by -\AboveNoteSpace
  \fi}
\def\cle@rn@tecl@ss#1{%
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname
  \global\setbox\th@cl@ss=\box\voidb@x}

% increment or decrement a given \dimen by the height of a given \box, unless void
\def\incr#1#2{\ifvoid#2\else\advance#1 by \skip#2\advance#1 by \ht#2\fi}
\def\decr#1#2{\ifvoid#2\else\advance#1 by-\skip#2\advance#1 by-\ht#2\fi}

% allocate some named registers for the \trial routine to use
\newbox\s@vedpage % to save the page contents for re-splitting columns
\newdimen\availht % overall available height
\newdimen\shortavail % shortened version of \availht for re-balancing loop
\newdimen\colhtA \newdimen\colhtB % dimen registers for calculating available ht for each col
\newbox\colA \newbox\colB % box registers to hold contents of the columns

\def\twocoltrial{% trial formatting to see if current contents will fit on the page
%%%  \msg{TRIAL with ht=\the\trialheight, vsize=\the\vsize}
  \edef\p@gebotmark{\botmark}% remember last \mark for running header
  \edef\t@st{\p@gefirstmark}%
  \ifx\t@st\empty\edef\p@gefirstmark{\firstmark}\fi % remember first, if not already set
  \availht=\trialheight % amount of space we think is available
  \let\\=\reduceavailht \the\n@tecl@sses % reduce it by the space needed for each note class
%%%
  \decr{\availht}{\topins}% and by the space needed for spanning pictures
  \decr{\availht}{\bottomins}
%%%
  \splittopskip=\topskip
  \setbox\s@vedpage=\copy255
  % figure out height available for each column, after subtracting
  % pictures placed at top or bottom of left or right column
  \colhtA=\availht \decr{\colhtA}{\topleftins} \decr{\colhtA}{\bottomleftins}
  \colhtB=\availht \decr{\colhtB}{\toprightins} \decr{\colhtB}{\bottomrightins}
  % split the galley into the two columns we need
  \setbox\colA=\vsplit255 to \colhtA % set \box\colA to amount which fits in first column
  \setbox\colB=\vsplit255 to \colhtB % and \colB to second
  \setbox\colA=\vbox{\unvbox\colA} % reset columns to natural height
  \setbox\colB=\vbox{\unvbox\colB}
  % and check if it all fit; if not, we'll have to back up and try again
  \ifvoid255 \fitonpagetrue \else \fitonpagefalse \fi
%%%  \msg{first col = \the\ht\colA, second col = \the\ht\colB, rem = \the\ht255}
  \iffitonpage
%%%    \msg{SUCCEEDED, shipping page}
    % re-split to better balance columns, if possible
    % at this point:
    %   \box\colA + \box\colB is the page content
    %   \availht is ht that definitely works
    %   \s@vedpage is a copy of the original page contents that was split into columns A and B
    %   try re-splitting with smaller ht while \ht\colB<\ht\colA
    %   (including allowance for column inserts)
    \colhtA=\ht\colA \incr{\colhtA}{\topleftins} \incr{\colhtA}{\bottomleftins}
    \colhtB=\ht\colB \incr{\colhtB}{\toprightins} \incr{\colhtB}{\bottomrightins}
    \ifdim\colhtB<\colhtA
      \rebalancetrue
      \shortavail=\availht
	  % loop making column height smaller.
	  % as long as everything still fits a shorter page is better balanaced
      \loop%\msg{re-balancing}
        \vfuzz=\maxdimen
        \advance\shortavail by -\baselineskip
        \setbox0=\copy\s@vedpage
        \colhtA=\shortavail \decr{\colhtA}{\topleftins} \decr{\colhtA}{\bottomleftins}
        \colhtB=\shortavail \decr{\colhtB}{\toprightins} \decr{\colhtB}{\bottomrightins}
        \setbox\colA=\vsplit0 to \colhtA \setbox\colA=\vbox{\unvbox\colA}
        \setbox\colB=\vsplit0 to \colhtB \setbox\colB=\vbox{\unvbox\colB}
		% if something left in box0, it didn't fit, quit loop
        \ifvoid0\else\rebalancefalse\fi
		% if second column longer than first column by more than .3*line height, quit loop
        \dimen0=\ht\colB \incr{\dimen0}{\topleftins} \incr{\dimen0}{\bottomleftins}
        \advance\dimen0 by -\ht\colA \decr{\dimen0}{\toprightins} \decr{\dimen0}{\bottomrightins}
        \ifdim\dimen0>.3\baselineskip \rebalancefalse\fi
		% give up if target size less than 3 lines (should not happen)
        \ifdim\shortavail<3\baselineskip \rebalancefalse\fi
        \ifrebalance\repeat
	  % last try failed, so back up to previous length
      \advance\shortavail by \baselineskip
      \colhtA=\shortavail \decr{\colhtA}{\topleftins} \decr{\colhtA}{\bottomleftins}
      \colhtB=\shortavail \decr{\colhtB}{\toprightins} \decr{\colhtB}{\bottomrightins}
      \setbox\colA=\vsplit\s@vedpage to \colhtA \setbox\colA=\vbox{\unvbox\colA}
      \setbox\colB=\vsplit\s@vedpage to \colhtB \setbox\colB=\vbox{\unvbox\colB}
    \fi
	% assemble final content of columns
    \dimen0=\dp\colA \setbox\colA=\vbox to \availht{\unvbox\topleftins\unvbox\colA\vfil\unvbox\bottomleftins}\dp\colA=\dimen0
    \dimen0=\dp\colB \setbox\colB=\vbox to \availht{\unvbox\toprightins\unvbox\colB\vfil\unvbox\bottomrightins}\dp\colB=\dimen0
	% define pagecontents for use by \plainoutput below
    \def\pagecontents{%
      \ifvoid\partial\else \unvbox\partial \fi % output partial page
      \ifvoid\topins\else \unvbox\topins \vskip\skip\topins \fi % output top spanning pictures
      \dimen0=\ifdim\dp\colB>\dp\colA \dp\colB \else \dp\colA \fi % calc depth of deepest column
      %\showthe\dimen0
	  % determine order of columns based on text direction
      \hbox to \textwidth{\ifRTL \box\colB\hfil\box\colA \else \box\colA\hfil\box\colB \fi}
      \ifvoid\bottomins\else \vskip\skip\bottomins \unvbox\bottomins \fi % ouput bottom spanning pictures
      \f@rstnotetrue
      \let\\=\ins@rtn@tecl@ss \the\n@tecl@sses % output all note classes
      \iff@rstnote % no notes actually occurred!
        \kern-\dimen0 \vfil
      \else
        \setbox0=\lastbox \dimen0=\dp0 \box0 \kern-\dimen0
      \fi
    }
    \resetvsize % reset size of next page since it will not have any 1 column material
    \plainoutput
    \xdef\p@gefirstmark{}
    \xdef\p@gebotmark{}
    \global\holdinginserts=1
    \global\output={\twocols}
  \else % the contents of the "galley" didn't fit into the columns,
        % so reduce \vsize and try again with an earlier break
%%%    \msg{REDUCING VSIZE}
    \global\advance\vsize by -\baselineskip
	% clear insertions
    \global\setbox\topins=\box\voidb@x
    \global\setbox\bottomins=\box\voidb@x
    \global\setbox\topleftins=\box\voidb@x
    \global\setbox\toprightins=\box\voidb@x
    \global\setbox\bottomleftins=\box\voidb@x
    \global\setbox\bottomrightins=\box\voidb@x
    \let\\=\cle@rn@tecl@ss \the\n@tecl@sses
    \global\setbox255=\box\voidb@x
    \global\holdinginserts=1
    \global\let\whichtrial=\twocoltrial
    \global\output={\backingup}
    \unvbox\galley \penalty\ifnum\galleypenalty=10000 0 \else \galleypenalty \fi
  \fi}
\newif\iffitonpage
\newif\ifrebalance

\def\backingup{% this output routine is used when we reduce \vsize;
               % it will cause a new page break to be found, and then the \trial routine is called again
%%%  \msg{BACKING-UP}
  \global\deadcycles=0
  \global\setbox\galley=\copy255
  \global\galleypenalty=\outputpenalty
  \global\output={\whichtrial}
  \global\holdinginserts=0
  \unvbox255 %\eject
  \penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi
}

\xdef\p@gefirstmark{}

% to switch back to single column, we reset the page size parameters
\def\singlecolumn{%
  \ifnum\c@rrentcols>1
    \ifhe@dings\endhe@dings\fi
    \vfill\eject
    \global\holdinginserts=1
    \global\hsize=\textwidth
    \global\vsize=\textheight
    \global\output={\onecol}
    \global\c@rrentcols=1
    \count255=1000
    \global\count\topins=\count255
    \global\count\bottomins=\count255
    \let\\=\s@tn@tec@unt \the\n@tecl@sses % reset \count for each note class
    \box\partial
    \vskip\baselineskip
  \fi}

\count\topins=1000 \dimen\topins=\maxdimen \skip\topins=0pt
\newinsert\bottomins \count\bottomins=1000 \dimen\bottomins=\maxdimen
\newinsert\topleftins \count\topleftins=1000 \dimen\topleftins=\maxdimen
\newinsert\toprightins \count\toprightins=1000 \dimen\toprightins=\maxdimen
\newinsert\bottomleftins \count\bottomleftins=1000 \dimen\bottomleftins=\maxdimen
\newinsert\bottomrightins\count\bottomrightins=1000 \dimen\bottomrightins=\maxdimen

% called from \fig or from figure list
\def\d@figure#1{%
  \gdef\p@rams{#1|}% ensure there is a trailing | separator
  % place parts of text into \param-1, \param-2, ...
  \global\p@ramnumber=1
  \loop
    \x@\getonep@ram\p@rams\end
    \ifx\p@rams\empty \morep@ramsfalse \else \morep@ramstrue \fi
    \ifmorep@rams\repeat
  % get size and location
  \lowercase{\edef\size@ption{\csname param-3\endcsname}}%
  \lowercase{\edef\loc@ption{\csname param-4\endcsname}}%
  % 
  \ifx\loc@ption\empty % if location empty
    \ifx\size@ption\size@SPAN%
	   \def\loc@ption{t}% if size is SPAN default to top
	\else\def\loc@ption{tl}\fi % else default to top left
  \fi
  % set width to column width or span width
  \p@cwidth=\ifx\size@ption\size@COL \hsize
  \else\ifx\size@ption\size@SPAN \textwidth
  \else \p@cwidth=\textwidth
    \errmessage{Unknown picture size "\size@ption", expected "col" or "span"}\fi\fi
  \let\p@cins=\relax
  % make \p@cins point to insertion class for this location
  \ifx\loc@ption\loc@T \let\p@cins=\topins
  \else\ifx\loc@ption\loc@B \let\p@cins=\bottomins
  \else
      \ifnum\c@rrentcols>1
        \ifx\loc@ption\loc@TL \let\p@cins=\topleftins
        \else\ifx\loc@ption\loc@TR \let\p@cins=\toprightins
        \else\ifx\loc@ption\loc@BL \let\p@cins=\bottomleftins
        \else\ifx\loc@ption\loc@BR \let\p@cins=\bottomrightins
        \fi\fi\fi\fi
      \else
        \ifx\loc@ption\loc@TL \picw@rning{tl}{t}\let\p@cins=\topins
        \else\ifx\loc@ption\loc@TR \picw@rning{tr}{t}\let\p@cins=\topins
        \else\ifx\loc@ption\loc@BL \picw@rning{bl}{b}\let\p@cins=\bottomins
        \else\ifx\loc@ption\loc@BR \picw@rning{br}{b}\let\p@cins=\bottomins
        \fi\fi\fi\fi
      \fi
  \fi\fi
  \ifx\p@cins\relax
    \errmessage{Unknown picture location "\loc@ption",
      expected one of t,b,tl,tr,bl,br}\let\p@cins=\topins
  \fi
  % create box to contain picture
  \setbox0=\vbox{
    \hsize=\p@cwidth
	% insert picture based on PicPath and file name, scaled to \p@cwidth
    \line{\XeTeXpicfile "\the\PicPath\csname param-2\endcsname" width \p@cwidth }
    \edef\r@f{\csname param-7\endcsname} % get reference
    \edef\c@ption{\csname param-6\endcsname} % get caption
    \ifx\c@ption\empty\else
      \everypar={}\let\par\endgraf
      \leftskip=0pt plus 1fil \rightskip=\leftskip \parfillskip=0pt
      \linepenalty=1000
	  % insert caption box
      \noindent\leavevmode
        \s@tfont{fig}\c@ption\unskip
        \ifx\r@f\empty\else\nobreak\ (\r@f\unskip)\fi
      \par
    \fi
    \vskip.5\baselineskip
  }%
  % insert into proper insertion class for this position
  \insert\p@cins{\penalty10000 % make sure this picture does not float away to another page
    \splittopskip\z@skip
    \splitmaxdepth\maxdimen \floatingpenalty20000 % was zero
    \gridb@x0% make sure we align to the page grid
  }%
}
\newtoks\PicPath % directory containing picture files

\def\picw@rning#1#2{\msg{converted picture placement "#1" to "#2" in single-column layout}}

\def\size@COL{col}
\def\size@SPAN{span}
\def\loc@T{t}
\def\loc@B{b}
\def\loc@TL{tl}
\def\loc@TR{tr}
\def\loc@BL{bl}
\def\loc@BR{br}

\newcount\p@ramnumber
\newdimen\p@cwidth
\newif\ifmorep@rams

% Place everything up to first | into \param-N.
% Redefine \p@rams to be rest of list
\def\getonep@ram#1|#2\end{\gdef\p@rams{#2}%
  \x@\gdef\csname param-\the\p@ramnumber\endcsname{#1}%
  \global\advance\p@ramnumber by 1 }

\def\includepdf{\@netimesetup % in case \ptxfile hasn't been used yet
  \ifx\XeTeXpdfpagecount\undefined
    \MSG{*** sorry, \string\includepdf\space requires XeTeX 0.997 or later}%
    \let\n@xt\relax
  \else \let\n@xt\incl@depdf \fi
  \n@xt}
\def\incl@depdf{\begingroup
  \m@kedigitsother \catcode`\[=12 \catcode`\]=12
  \futurelet\n@xt\t@stincl@de@ptions}
\def\t@stincl@de@ptions{\ifx\n@xt[\let\n@xt\incl@de@ptions
  \else\let\n@xt\incl@deno@ptions\fi\n@xt}
\def\incl@deno@ptions#1{\incl@de@ptions[]{#1}}
\def\incl@de@ptions[#1]#2{%
  \totalp@ges=\XeTeXpdfpagecount "#2"\relax
  \whichp@ge=0
  \loop \ifnum\whichp@ge<\totalp@ges
    \advance\whichp@ge by 1
    \setbox0=\hbox{\XeTeXpdffile "#2" page \whichp@ge #1}%
    \ifdim\wd0>\pdfpagewidth
      \setbox0=\hbox{\XeTeXpdffile "#2" page \whichp@ge #1 width \pdfpagewidth}%
    \fi
    \ifdim\ht0>\pdfpageheight
      \setbox0=\hbox{\XeTeXpdffile "#2" page \whichp@ge #1 height \pdfpageheight}%
    \fi
    {\def\c@rrID{#2 #1 page \number\whichp@ge}% for lower crop-mark info, if requested
      \setbox0=\vbox{\kern-\baselineskip \box0 \kern\baselineskip}%
      \shipwithcr@pmarks{\box0}}%
    \advancepageno
    \repeat
  \endgroup % begun in \incl@depdf
}
\newcount\totalp@ges
\newcount\whichp@ge

\def\pagebreak{\vfill\eject %% FIXME
  \ifnum\c@rrentcols=2
%    \iffirstcol\else\line{}\vfill\eject\fi
  \fi
}
\let\pb=\pagebreak

\def\columnbreak{\vfill\eject}

\tolerance=9000
\hbadness=10000
\emergencystretch=1in
\vbadness=10000
\vfuzz=2pt
\frenchspacing

\XeTeXdashbreakstate=1 % allow line-break after en- and em-dash even if no space

\catcode`\[=\active \def[{\char`\[\ignorespaces}
\catcode`\(=\active \def({\char`\(\ignorespaces}

\catcode"AD=\active \let^^ad=\- % make Unicode SOFT HYPHEN into a TeX discretionary hyphen
\catcode"A0=\active \def^^a0{\penalty10000\ } % make Unicode NO-BREAK SPACE into a no-break space
\catcode"200B=\active \def^^^^200b{\hskip0pt \relax} % ZERO WIDTH SPACE is a possible break

\catcode`\@=12

\parskip=0pt
\baselineskip=14pt
\lineskip=0pt

\widowpenalty=10000
\clubpenalty=10000
\brokenpenalty=50

\endinput
