\newif\iflua\luafalse
\def\pluginlist{polyglot-complexpages}
\input paratext2.tex
\FastTracing
\tracing{dmc}  
\tracing{dmp}  
\tracing{tim}  
\XeTeXuseglyphmetrics=0
\FontSizeUnit=1pt
\catcode`\/=12
\font\T "Gentium Plus" at 10pt
\def\regular{"Gentium Plus"}
\def\bold{"Gentium Plus/B"}
\def\italic{"Gentium Plus/I"}
\PaperHeight=296mm
\PaperWidth=210mm
\baselineskip=12pt
\showboxbreadth=100
\newPolyglotCol{L}
\newPolyglotCol{R}
\newPolyglotCol{A}
\newPolyglotCol{C}
\def\DiglotLFraction{0.5}
\def\DiglotRFraction{0.5}
\def\DiglotAFraction{1}
\def\DiglotCFraction{0.5}

\diglottrue
\stylesheet{usfm_sb.sty}
\polyglotpages{LL/A,RR/A,C}
\def\LineSpacingFactor{1.0}
\def\VerticalSpaceFactor{1}
\everypar{}
\let\par\endgraf
\T
\makeatletter
\count\topleftins=1000
\floatingpenalty=10000
\setbox\excessL\vbox{\hsize=100pt
\mark{a:1:1}\penalty10000 Sapiente eum quasi qui\insert\csname note-f\endcsname{\vbox{hello this is a test\par lets make it longer}\vbox{with another box}} eligendi quasi atque delectus in.\insert\topleftins{\vbox{another line}} \mark{a:1:2}Consequuntur blanditiis consequatur dolorem corporis similique qui voluptas. \mark{a:1:3}Tempora dolor quibusdam dolor quod provident illum rerum. \mark{a:1:4}Voluptatem tempora blanditiis expedita quibusdam sunt aut explicabo perferendis. \mark{a:1:5}Molestiae qui molestias nihil sed.Laudantium eius asperiores expedita consequuntur. \par
\vbox to 3\baselineskip{\hbox{Hi}\vfill}\penalty10000
\insert\toprightins{\vbox{another line}}\mark{a:1:6}Dolores nostrum nihil vel placeat. \mark{a:1:7}Expedita voluptatem iusto dolorem. \mark{a:1:8}Sit eaque adipisci voluptate itaque tenetur consequuntur quam error.Pariatur praesentium recusandae qui harum. \mark{a:1:9}Eveniet quia sed voluptatem. \mark{a:1:10}Voluptatum eaque pariatur id eveniet ratione. \mark{a:1:11}Veritatis fugiat error doloribus laboriosam ipsum libero et dicta. \mark{a:1:12}Delectus molestiae eveniet odit magnam magni. \mark{a:1:13}Itaque sed corporis aut autem dignissimos maxime.}
\setbox\excessR\vbox{\hsize=100pt . \mark{a:1:1}Repellat nihil autem quod doloremque adipisci illum officia laudantium. \mark{a:1:2}Voluptate dignissimos itaque odit. \mark{a:1:3}Et omnis veritatis magnam rem doloremque. \mark{a:1:4}Pariatur laudantium iusto illo. \mark{a:1:5}A eos corporis ab quae iure non.Porro et necessitatibus quam. \mark{a:1:6}Culpa dolor est porro error voluptatem enim non. \mark{a:1:7}Nulla tempore quia praesentium facere dolores omnis. \mark{a:1:8}Quam ut asperiores magni in expedita aut qui. \mark{a:1:9}Quos sit voluptas accusantium non doloremque fugiat placeat voluptas.Perspiciatis quis odio facere ad velit exercitationem deserunt. \mark{a:1:10}Temporibus fuga non omnis harum ut voluptates explicabo. \mark{a:1:11}Nulla rerum quia consequatur. \mark{a:1:12}Ut dolor aspernatur porro dicta quod. \mark{a:1:13}Quo eos qui mollitia. \mark{a:1:14}Aut ratione voluptate debitis et vero est.}
\setbox\excessA\vbox{\hsize=200pt 
. \mark{a:1:1}Illum cupiditate velit repellendus aliquid impedit. \mark{a:1:2}Beatae et ut quod a doloribus. \mark{a:1:3}Sunt ut et eos aut sunt tempore. \mark{a:1:4}Sit quaerat quae tempore molestiae delectus ratione non. \mark{a:1:5}Est cum atque numquam minus non nesciunt et.Nisi modi eaque inventore architecto eveniet repudiandae. \mark{a:1:6}Amet ut quo impedit molestiae. \mark{a:1:7}Voluptatem dolorem reiciendis ut voluptas explicabo qui quo. \mark{a:1:8}Corrupti et dolore in et tenetur et cupiditate autem. \mark{a:1:9}Similique et et delectus.Ut quam mollitia voluptatem ipsa id. \mark{a:1:10}Velit quas maiores temporibus dolore. \mark{a:1:11}Sequi autem facere omnis et dicta totam est hic. \mark{a:1:12}Id sed unde similique mollitia sed aliquid.}
\endgraf
\def\ins@meas@trialpenalty{-10010}
%\tracingmacros=1
%\tracingassigns=1
\ptxfile{}\everypar{}\let\par\endgraf
\MSG{L: \l@gdims\excessL}
\MSG{A: \l@gdims\excessR}
%\MSG{\l@gdims\excessA}
\newcount\cols
\newdimen\max
\iflua
\directlua{
  require("measurebox.lua")
}
\fi


\MSG{bls:\the\baselineskip}
\def\try#1{\count255=1 \max=0pt
  \cols=\csname cols#1\endcsname
  \setbox0\copy\csname excess#1\endcsname
  \let\dims\empty
  \let\ins@rtl@st\empty
  \def\ins@meas@trial@result{0pt}%
  \def\ins@meas@trial@dims{}%
  \let\ins@rtsplitlist\empty
  \loop
    \setbox\count255=\vsplit0 to \dimen1\setbox \count255\vbox{\unvbox\count255}%
    \ifdim\max<\ht\count255 \max=\ht\count255 \fi
    \edef\dims{\ifx\dims\empty\else\dims,\fi \the\ht\count255}%
    \edef\tmp{\splitbotmark}
    \ifx\tmp\empty
      \x@\edef\csname #1bot\endcsname{0}%
    \else
      \x@\extr@ctfirst\splitbotmark\relax
      \x@\edef\csname #1bot\endcsname{\v@rsefrom}%
    \fi
    \iflua\directlua{measure_ins(\the\count255)}
      \trace{imt}{ins@meas@trial@result=\ins@meas@trial@result(\ins@meas@trial@dims)}%
    \else
      \ins@meas@trialfullfalse
      \me@sureins@trial{#1}{\the\count255}%
    \fi
    \edef\ins@rtl@st{\ifx\ins@rtl@st\empty\else\ins@rtl@st+\fi\ins@meas@trial@result}%
    \edef\ins@rtsplitlist{\ifx\ins@rtsplitlist\empty\else\ins@rtsplitlist+\fi\ins@meas@trial@dims}%
  \ifnum \count255<\cols
    \advance\count255 by 1
    \repeat
  \count255=1 
  % Sum (maxht - column ht) for all columns. - measure of unevenness
  \dimen0=0pt
  \loop
    \advance\dimen0\dimexpr\max-\ht\count255\relax
  \ifnum \count255<\cols
    \advance\count255 by 1
    \repeat
  \x@\let\x@\tmp\csname #1list\endcsname  
  \edef\tryid{#1/\the\dimen1}
  \x@\xdef\csname #1list\endcsname{\ifx\tmp\relax\else\tmp\fi\tryid,}
  \edef\tmp{\the\max|\number\dimexpr 10\dimen0 /\baselineskip\relax|\csname #1bot\endcsname|\dims|\ins@rtl@st|\ins@rtsplitlist}\trace{dmc}{\tryid: \tmp}\par
  \x@\let\csname \tryid\endcsname\tmp
}






\def\p@rsepathstr#1|#2\E{%remove logging info from a pathstring
  \def\p@th{#1}%
}

\def\cplx@apply#1{%
  \x@\p@rsepatstr#1|\E% | is so we can cope if the logging info is ever removed
}  

\def\unbalVcost{10} % cost per verse^2-difference (an unbalanced line is 10 * worse than a verse or 2's imbalance, but 1 unbalanced line is not worth 10 verses delta)
\def\unbalLcost{10} % cost per 1/10 of an unblanced line -> 1 line unbalanced is worth 10 verses??
\def\WScost{3} % cost per pt of whitespace
\def\maxv{0}
\def\minv{999}
\def\sc@re#1{% Determine a 'cost' for a the option-tree so-far, plus this final split
  \x@\let\x@\tmp\csname#1\endcsname % 
  \x@\p@rsetry\tmp\E
  \advance\tryscore by \unbalLcost\dimexpr\p@rseunbal pt\relax\relax
  \edef\ubal{\ubal+\p@rseunbal}%
  \ifnum\p@rsev>\maxv \let\maxv\p@rsev \fi
  \ifnum\p@rsev<\minv \let\minv\p@rsev \fi
  \trace{dmc}{\p@rsev: min,max = \minv,\maxv}%
  \advance\dimen0 by -\p@rsemx\relax
  \ifdim\dimen0<0pt
    \trace{dmc}{STOP: \the\dimen0} % Don't go deeper, there's no space
    \aftergroup\n@more
  \else
    \dimen1=\unbalVcost\dimexpr \numexpr (\maxv-\minv)*(\maxv-\minv)\relax pt\relax
    \ifx\nxt@ptions\empty
      \advance\tryscore by \dimen1
      \advance\tryscore by \WScost\dimexpr \dimen0\relax
      \edef\tmp{\path|\minv|\maxv|\the\dimen0|\ubal|\the\tryscore}\trace{dmc}{\tmp}%\tmp\par
      \ifdim\tryscore<\bestscore
        \xdef\bestscore{\the\tryscore}
        \xdef\bestpath{\tmp}
        \trace{dmc}{new bestscore:\bestscore}%
      \fi
    \else
      \trace{dmc}{current:\the\tryscore+\the\dimen1 \space next chunk:\nxt@ptions}%
      \ifdim\dimexpr \tryscore+\dimen1\relax > \bestscore
        \trace{dmc}{STOP:Already worse}%
      \else
        \x@\@ption\nxt@ptions\E
      \fi
    \fi 
  \fi
}
\newdimen\tryscore
\def\options#1{%
  \dimen0=\tot
  \edef\bestscore{\the\maxdimen}
  \def\path{}\def\psep{}\tryscore=0pt
  \def\ubal{}
  \x@\@ption#1\E
}
%\l@gdims0 \l@gdims\excessL
\newcount\trynum
\def\presplit#1{%
  \trynum=#1
  \advance\dimen1 by -#1\baselineskip
  \@presplit
}

\def\@presplit{
  \splittask
  \advance\dimen1 by \baselineskip
  \advance\trynum by -1
  \ifnum\trynum>0
    \let\@nxt=\@presplit
  \else
    \let\@nxt\relax
  \fi
  \@nxt
}

\newcount\nsplit
\tracingstats=1
\nonstopmode
\tracetimset{rsplit}\relax
%\tracingassigns=1
\complex@rsplit L
%\tracingassigns=0
\tracetimcheck{rsplit}{recursive L}

\def\ssr@sult{}
\tracetimset{ssplit}\relax
\complex@ssplit L
\trace{dmc}{ssplit: \ssr@sult}
\tracetimcheck{ssplit}{sequential L}

\tracetimset{rsplit}\relax
\complex@rsplit R
\tracetimcheck{rsplit}{recursive R}
\def\ssr@sult{}
\tracetimset{ssplit}\relax
\complex@ssplit R
\trace{dmc}{ssplit: \ssr@sult}
\tracetimcheck{ssplit}{sequential R}
\newbox\excessC
\setbox\excessC\vbox{\unvcopy \excessL \unvcopy \excessL \unvcopy \excessL \unvcopy \excessL \unvcopy \excessL \unvcopy \excessL}
%\setbox\Cbox\vbox{\unvcopy \excessL \unvcopy \excessL \unvcopy \excessL \unvcopy \excessL \unvcopy \excessL \unvcopy \excessL}
\tracetimset{rsplit}\relax
\complex@rsplit C
\tracetimcheck{rsplit}{recursive C}
\def\ssr@sult{}
\tracetimset{ssplit}\relax
\complex@ssplit C
\trace{dmc}{ssplit: \ssr@sult}
\tracetimcheck{ssplit}{sequential C}

\trace{dmc}{---------------------------------}
\def\@ption#1#2\E{\bgroup
  \trace{dmc}{@option #1 #2}%
  \edef\nxt@ptions{#2}
  \x@\let\x@\l@st\csname #1list\endcsname
  \x@\suboptions\l@st\E
  %\ifx\nxt@ptions\empty
    %\global\let\@nxt\cstackrelax
  %\else\global\let\@nxt\@ption\fi
  %\x@\@nxt\nxt@ptions\E
  \egroup
}
\def\n@more{\let\s@tmp\empty}
\def\suboptions#1,#2\E{%
  \edef\s@tmp{#2}%
  \bgroup
    \edef\path{\path\psep#1}%
    \def\psep{,}
    \trace{dmc}{scoring suboption #1 : \path (#2)}%
    \sc@re{#1}
  \egroup%
  \ifx\s@tmp\empty\let\n@xt\cstackrelax
  \else\let\n@xt\suboptions\fi
  \n@xt#2\E
}

\def\p@rsetry#1|#2|#3|#4|#5|#6\E{%
  \def\p@rsemx{#1}% The maximum height of a column (and thus of this column block)
  \def\p@rseunbal{#2}% Unbalanced columns, in deci-baselineskips
  \def\p@rsev{#3}% Verse difference     
  \def\p@rsecoldims{#4}% Actual column differences
  \def\p@rsins{#5}% column insert measurements
  \def\p@rsinssplit{#6}% detailed insert numbers
}

\tracing{dmc}  
%\def\MSG#1{}
\count255=0
\edef\start{\the\elapsedtime}
\def\colsL{2}\def\colsR{2}\def\colsA{1}
\dimen1=\ht\excessL \divide\dimen1 by \colsL
\def\splittask{\try{L}\try{R}\try{A}}
%\loop\bgroup
  \let\Llist\relax\let\Rlist\relax
  \presplit{10}
%%\egroup\advance\count255 by 1 \relax 
  %\ifnum\count255<100\repeat

\edef\stop{\the\elapsedtime}
\MSG{Splitting: \the\dimexpr \numexpr\stop-\start\relax pt / 65536\relax}

%\bye \endinput
\edef\tot{\the\dimexpr 0.9\ht\excessL}%

L:\Llist\par
R:\Rlist\par
A:\Alist

%\tracingassigns=1
\edef\start{\the\elapsedtime}
\options{LRA}%
\edef\stop{\the\elapsedtime}
\message{Scoring: \the\dimexpr(\numexpr \stop -\start \relax pt)/65536\relax}
\MSG{Target: \tot}
\MSG{Best score: \bestscore}
\MSG{Best path: \bestpath} 
\let\par\endgraf
%BEST: \bestpath\par
%\cplx@apply{\bestpath}

%\showbox\excessL
\par
%\tracing{d}
%\tracing{o}
%%\SHOWSTUFF
%\tracingall
%\box\excessL
\def\digl@tc@ntentlist{LRA}
\tracing{imt}
\ifdim\pagetotal>0pt \pagebreak \fi
\setbox\excessL\box\Lbox
\setbox\excessA\box\Abox
\setbox\excessR\box\Rbox
\message{dim: xL \l@gdims{\excessL}, xR \l@gdims{\excessR}, xA \l@gdims{\excessA}}%
%\showbox\excessL
%\FastTracing
\Xtest=54pt
\Ytest=58pt
\Ztest=45pt
\Atest=27pt
\Ltest=50pt
\Rtest=55pt
\dimen\csname note-f\endcsname=10pt
\x@\def\csname note-fht\endcsname{12pt}
%\tracingassigns=1
\diglot@run@trials@complexpages
%\tracingcommands=3
%\tracingmacros=3
\message{p@gehtcalcs is: \x@\meaning\csname p@gehtcalcs-0\endcsname. htfunction is \x@\meaning\csname htfunction-0-0\endcsname}
\csname p@gehtcalcs-0\endcsname
\csname p@gehtcalcs-1\endcsname
\p@lyp@geno=0
\@me@surepages
\tracingmacros=0
\tracingassigns=0
\tracingcommands=0
\message{lengths: \the\csname p@gehtloss-0\endcsname, \the\csname p@gehtloss-1\endcsname}
\relax
\bye
