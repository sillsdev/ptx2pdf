%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007-2020 by SIL International
% original parts by Johnathan Kew, 
% split off into separate parts and recent additions by David Gardner
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \fig handling code, originally from paratext2.tex

% Inserts
%\newinsert\topins is already defined in plainTeX
\count\topins=1000 \dimen\topins=\maxdimen \skip\topins=0pt
\newinsert\bottomins \count\bottomins=1000 \dimen\bottomins=\maxdimen
\newinsert\verybottomins \count\verybottomins=0 \dimen\verybottomins=\maxdimen
\newinsert\topleftins \count\topleftins=0 \dimen\topleftins=\maxdimen
\newinsert\toprightins \count\toprightins=0 \dimen\toprightins=\maxdimen
\newinsert\bottomleftins \count\bottomleftins=0 \dimen\bottomleftins=\maxdimen
\newinsert\bottomrightins\count\bottomrightins=0 \dimen\bottomrightins=\maxdimen
\newcount\tmpcountB
\def\colinsert@name#1{colinsert@#1}
\let\colinsert@tL\topleftins
\let\colinsert@bL\bottomleftins
\let\colinsert@tR\toprightins
\let\colinsert@bR\bottomrightins

\def\pageins@rts{bottomins,verybottomins,topins,}
\def\columnins@rts{colinsert@tL,colinsert@tR,colinsert@bL,colinsert@bR,}
%toprightins, bottomleftins etc. are now aliases
\edef\ins@rts{\columnins@rts\pageins@rts}

\def\s@veclasses{col,chunk,} % diglot needs to save two distinct states per box.
\def\s@veins@class@name#1#2{save#1#2}
\def\s@veclass@name#1{\s@veins@class@name{#1}{\s@veclass}}
\def\m@kes@veb@x#1\E{\x@\newb@x\csname \s@veins@class@name{\ins@base}{#1}\endcsname}
\def\s@veins#1\E{\x@\setbox\x@3\x@\copy\csname #1\endcsname\x@\global\x@\setbox\csname \s@veclass@name{#1}\endcsname\box3}
\def\r@strins#1\E{\x@\setbox\x@3\x@\copy\csname \s@veclass@name{#1}\endcsname\x@\global\x@\setbox\csname #1\endcsname\box3}
\def\sh@winsertdim#1\E{\x@\let\x@\tmp\csname \v@lpfx#1\v@lsfx\endcsname\immediate\write-1{\v@lpfx#1\v@lsfx: \ifx\tmp\relax\else\the\ht\tmp\space x \the\wd\tmp\fi}}

\def\m@keinsertsaveboxes#1\E{\edef\ins@base{#1}\let\D@=\d@\let\d@=\m@kes@veb@x
  \x@\cstackdown\s@veclasses\E
  \let\d@=\D@
}

\def\s@veinserts#1{%loop through \ins@rts and save them 
  \trace{gI}{Saving inserts (#1)}%
  \edef\s@veclass{#1}%
  \let\d@=\s@veins
  \x@\cstackdown\ins@rts\E 
} 

\def\r@storeinserts#1{%loop through \ins@rts and save them 
  \trace{gI}{Restoring inserts (#1)}%
  \edef\s@veclass{#1}%
  \let\d@=\r@strins
  \x@\cstackdown\ins@rts\E
} 


% Generate the insert save-boxes for each class at start-up
\addtoinithooks{\let\d@=\m@keinsertsaveboxes\x@\cstackdown\ins@rts\E}

%%%%%%%%%%%%%% FIGURES %%%%%%%%%%%%%% 
% called from \fig or from figure list

% Place everything up to first | into \param-N.
% Redefine \p@rams to be rest of list
%+cfig_stripspace
\def\stripspace#1 \end/#2\relax#3{\if\relax#2\relax\xdef\p@ram{#3}\else\stripspace#1\end/ \end/\relax{#1}\fi}
%-cfig_stripspace
%+cfig_getonepair
%\def\FigP@ramAlt{alt} \def\FigP@ramSrc{src} \def\FigP@ramSize{size} \def\FigP@ramLoc{loc}
%\def\FigP@ramCopy{copy} \def\FigP@ramRef{ref} \def\FigP@ramXtra{x-xetex} \def\FigP@ramPgpos{pgpos}
%\def\FigP@ramMirror{mirror} \def\FigP@ramScale{scale}  \def\FigP@ramMedia{media}

\def\s@tp@ramid{%This is used both to decode numeric parameters and to reset named parameters.
  \ifnum \p@ramnumber<0 
    \edef\p@ramid{NEG\the\p@ramnumber}%
  \else
    \ifnum \p@ramnumber>17 \global\morep@ramsfalse\fi
    %WARNING: There must not be a space after the text(before \or / \else / \fi) or (re)-initialisation will break
    \edef\p@ramid{\ifcase\p@ramnumber UNK-0\or alt\or src\or size\or loc\or copy\or caption\or ref\or x-xetex\or mirror\or 
        scale\or media\or pgpos\or x-credit\or x-creditpos\or
	x-creditrot\or x-creditbox\or x-spacebeside\else UNK-\the\p@ramnumber\fi}%
  \fi
}
\newif\ifusfmthree \usfmthreefalse
\lowercase{\def\setp@r@mid #1#2\E{\edef\p@ramid{\ifx ~#1\else #1\fi#2}}}% Kill off infuriating leading space issue
\def\getonepairp@ram#1="#2" {\stripspace#1\end/ \end/\relax{#1}\ifx\p@ram\empty\let\p@ramid\empty\else\x@\setp@r@mid\p@ram\E\fi
  \stripspace#2\end/ \end/\relax{#2}\edef\p@ramval{\p@ram}%
  \trace{g}{getonepairparam: [\p@ramid] = [\p@ramval]}%
  \ifx\p@ramid\empty\let\fnext=\relax\else
    %\ifx\p@ramid\FigP@ramSrc\global\p@ramnumber=2\else
    %\ifx\p@ramid\FigP@ramSize\global\p@ramnumber=3 \trace{g}{Got Size}\else
    %\ifx\p@ramid\FigP@ramLoc\global\p@ramnumber=\x@\ifx\csname param-4\endcsname\empty 4\else 5\fi\else
    %\ifx\p@ramid\FigP@ramPgpos\global\p@ramnumber=4\else
    %\ifx\p@ramid\FigP@ramCopy\global\p@ramnumber=5\else
    %\ifx\p@ramid\FigP@ramAlt\global\p@ramnumber=6\else
    %\ifx\p@ramid\FigP@ramRef\global\p@ramnumber=7\else
    %\ifx\p@ramid\FigP@ramXtra\global\p@ramnumber=8\else %experimental extra parameter, post filename e.g. "rotated 90"
    %\ifx\p@ramid\FigP@ramMirror\global\p@ramnumber=9\else %experimental mirror parameter.
    %\ifx\p@ramid\FigP@ramScale\global\p@ramnumber=10\else
    %\ifx\p@ramid\FigP@ramMedia\global\p@ramnumber=11\else
    \ifx\p@ramval\empty
      \ifusfmthree
        \let\fnext=\getonepairp@ram
      \else
        \let\p@ramval=\p@ramid
        \ifnum\p@ramnumber>0 
          \s@tp@ramid
        \else
          \edef\p@ramid{error}%
        \fi
        \let\fnext=\relax 
        \trace{g}{usfm2 style parameter (\p@ramid=)\p@ramval}%
       \fi
    \else
      \trace{g}{usfm3 parameter \p@ramid=\p@ramval}%
      \ifusfmthree\else %first usfm3 parameter. USFM3 says first param is comment,  not alt-text. Swap them
        \x@\let\x@\t@mp\csname figparam-alt\endcsname
      	\x@\global\x@\let\csname figparam-caption\endcsname\t@mp
      	\x@\global\x@\let\csname figparam-alt\endcsname\empty
        \usfmthreetrue
      \fi
      \let\fnext=\getonepairp@ram
      %\trace{g}{Unrecognised usfm3 parameter \p@ramid}\p@ramnumber=-1%
    \fi% If there's no value, it's probably usfm2-style
    \x@\global\x@\let\csname figparam-\p@ramid\endcsname\p@ramval
    %\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi
   % \tempfalse
   % \ifx\p@ramval\empty\ifusfmthree\else
   %   \trace{g}{param-\the\p@ramnumber = "\p@ramid" but not "\p@ramval"}%
   %   \x@\global\x@\edef\csname param-\the\p@ramnumber\endcsname{\p@ramid}%
   %   \let\fnext=\relax
   %   \temptrue
   % \fi\fi
   % \iftemp\else
   %   \trace{g}{param-\the\p@ramnumber [\p@ramid]  = "#2" from "\p@ramval"}%
   %   \x@\gdef\csname param-\the\p@ramnumber\endcsname{#2}%
   %   \let\fnext=\getonepairp@ram \usfmthreetrue
   % \fi
  \fi\fnext}
%-cfig_getonepair

%+cfig_parsesize
\def\p@rsesize#1*#2*#3\end{%
  \global\def\size@ption{#1}%
  \edef\tmp{#2}%
  \if\tmp\relax\relax\else\def\sizem@ltiple{#2}\trace{g}{Setting scale to #2}\fi% empty if not provided
}
%-cfig_parsesize

%+cfig_parsextra
\def\getnum#1=#2\end{#1}%
 
% These three macros split up x-xetex="foo" parameter, stripping out any key=val formated parameters and leaving the rest.
% 

\def\p@rs@xtr@#1=#2=#3\end{\edef\t{#2}%
  \ifx\t\empty \edef\t{#1}%
    \ifx\t\empty\else
      \edef\xtraremains{\xtraremains#1\space}\trace{g}{Passing #1 directly to xetex}%
    \fi
  \else
    \trace{g}{Found k=#1,v=#2 (x=#3)}%
    \def\key{#1}\def\val{#2}%
    \ifx\key\keyR@TATE \rotimagetrue
      \ifx\val\val@BIND \ifodd\whichp@ge\def\xtra{rotated 90}\else\def\xtra{rotated -90}\fi
      \else
        \ifx\val\val@EDGE \ifodd\whichp@ge\def\xtra{rotated -90}\else\def\xtra{rotated 90}\fi
        \else \tempfalse \t@mpfalse
          \ifx\val\val@dd \t@mptrue \ifodd\whichp@ge\temptrue\fi\fi
          \ifx\val\val@ven \t@mptrue \ifodd\whichp@ge\else\temptrue\fi\fi
          \iftemp \edef\angle{\getnum#3==\end}%
            \ifx\empty\angle \message{Expected rotate=\val=42 or similar in definition of picture \f@lename}%
            \else \xdef\xtra{rotated \angle}\fi
          \fi
          \ift@mp\else
            \message{Unexpected value rotate=#2. Expected values "edge", "binding", "odd", or "even"}%
          \fi
        \fi
      \fi
    \else
      \ifx\key\keyP@GE
	\ifx\picfilecomm@nd\XeTeXpdffile
	  \edef\picp@ge{page \val}%
        \else
	  \message{Not a PDF file, page=... only supported on PDFs}%
	\fi
      \else
	\message{Unexpected key #1=#2. Expected key "rotate"}%
      \fi
    \fi
  \fi
}
\def\p@rsextr@#1 #2\relax{%                                                     %(2)
  \trace{g}{processing #1}%
  \edef\t{#2}\ifx\t\empty\let\n@xt=\relax\fi
  \edef\t{#1}\ifx\t\empty\let\n@xt=\relax
  \else \x@\p@rs@xtr@\t==\end \fi
  \x@\n@xt#2 \relax
}
\def\p@rsextra#1{%                                                              %(1)
  \trace{g}{Parsing #1}%
  \edef\@rg{#1 }%Space is needed!
  \def\xtraremains{}\let\n@xt=\p@rsextr@
  \edef\t{#1}\ifx\t\empty\let\n@xt=\relax\fi
  \x@\n@xt\@rg  \relax
}
%-cfig_parsextra

%+cfig_getoneparam
\def\getonep@ram#1|#2\end{\gdef\p@rams{#2}%
  \trace{g}{getoneparam: #1 | #2}%
  \getonepairp@ram#1 ="" \relax%
  \global\advance\p@ramnumber by 1 }
%-cfig_getoneparam

\newif\iffiglocleft \figloclefttrue
\newif\ifpicUsesIns \picUsesInstrue
\newif\ifpicNarrow \picNarrowfalse
\newif\ifrotimage
\newif\ift@mp %because just one temp isn't enough

%+cfig_parsepicuse
\def\p@rsePicXtra#1#2\end{% Parse optional new picture options, and remember them
  \xdef\l@cspec@b{#1}\xdef\l@cspec@c{#2}%
}
\def\p@rseLoc#1#2\end{% Parse the new picture options, and remember them
  \edef\l@cspec@a{#1}\edef\l@cspec@b{#2}%
  \ifx\l@cspec@b\empty\let\l@cspec@c=\l@cspec@b\else\x@\p@rsePicXtra\l@cspec@b\end\fi
  \trace{g}{p@rseLoc: #1 \l@cspec@b|\l@cspec@c}%
  % inner/outer support for everything
  \tempfalse
  %Switch relative (inner/outer) to absolute (left/right) depending on page number for this image.
  \ifx\l@cspec@b\@lignOuter\temptrue\ifodd\whichp@ge\let\l@cspec@b=\@lignRight\else\let\l@cspec@b=\@lignLeft\fi\fi
  \ifx\l@cspec@b\@lignInner\temptrue\ifodd\whichp@ge\let\l@cspec@b=\@lignLeft\else\let\l@cspec@b=\@lignRight\fi\fi
}

%NB THIS IS ONLY for page-based items, not for e.g. captions. 
\def\p@rsePicUse#1\end{% Parse the new picture options, and remember them. 
  \x@\p@rseLoc#1\end % sets \l@cspec@a, \l@cspec@b, \l@cspec@c to chars 1, 2, 3+
  \iftemp
    % inner/outer support for inserts
    \trace{g}{Page \the\whichp@ge, defined #1 to \l@cspec@a, \l@cspec@b, \l@cspec@c}%
  \fi
  \tempfalse
  \ifx\l@cspec@a\loc@T\temptrue\fi
  \ifx\l@cspec@a\loc@B\temptrue\fi
  \iftemp
    \ifx\l@cspec@b\empty\else 
      \ifnum\c@rrentcols>1\else
        \tempfalse %Can't do it.
      \fi
    \fi
    %redefine loc@ption
    \iftemp
      \xdef\loc@ption{\l@cspec@a\l@cspec@b}%
    \else
      \let\l@cspec@b\empty
      \x@\let\x@\tmp\csname \w@tsit @warning\endcsname
      \ifx\tmp\relax
        \picw@rning{#1}{\l@cspec@a\l@cspec@b}%
      \else 
        \tmp{#1}{\l@cspec@a\l@cspec@b}%
      \fi
      \xdef\loc@ption{\l@cspec@a}%
    \fi
  \fi
  % new options
  \ifx\l@cspec@a\loc@Inl
    \trace{g}{Experimental inline \w@tsit}%
    \global\let\picl@c\loc@Inl\xdef\pic@lign{\l@cspec@b}\global\picUsesInsfalse\p@cinswid=\hsize
    \ifx\l@cspec@b\@lignLeft\picNarrowtrue\fi
    \ifx\l@cspec@b\@lignRight\picNarrowtrue\fi
  \fi
  \ifx\l@cspec@a\loc@Cut
    \global\let\picl@c\loc@Cut\global\picUsesInsfalse\global\picNarrowtrue\p@cinswid=\hsize
    \xdef\l@cspec{\l@cspec@b}%
    \ifx\l@cspec@c\empty\gdef\c@tskip{0}\else\xdef\c@tskip{\l@cspec@c}\fi%
    \trace{g}{Experimental \w@tsit in cutout, after \c@tskip lines}%
    \x@\c@tskipparse\c@tskip...\E %split c@tskip into whole and fractional parts.
  \fi
  \ifx\l@cspec@a\loc@Par
    \global\let\picl@c=\loc@Par\p@cinswid=\hsize\trace{g}{Experimental after-paragraph \w@tsit}%
    \xdef\pic@lign{\l@cspec@b}\global\picUsesInsfalse
    \ifx\l@cspec@b\@lignLeft\picNarrowtrue\fi
    \ifx\l@cspec@b\@lignRight\picNarrowtrue\fi
    \ifx\l@cspec@c\empty\gdef\c@tskip{0}\else\xdef\c@tskip{\l@cspec@c}\fi%Borrow cutskip for parskip
  \fi
  % full-page options
  \tempfalse
  \ifx\l@cspec@a\loc@Page\global\let\picl@c=\loc@Page\global\picUsesInsfalse\temptrue\fi
  \ifx\l@cspec@a\loc@Full\global\let\picl@c=\loc@Full\global\picUsesInsfalse\temptrue \p@cinswid=\PaperWidth\fi
  \iftemp
    \xdef\pic@lign{\l@cspec@b}\xdef\picV@lign{\l@cspec@c}%
    \trace{g}{Experimental page / full-page \w@tsit (\pic@lign|\picV@lign)}%
  \fi
}
%-cfig_parsepicuse

%+cfig_docaption
\def\DecorateRef#1{(#1)}

\def\d@c@ption#1{% Called with #1= diglot column or {} for normal.
  \edef\cpt@mp{#1}%
  \x@\let\x@\thsr@f\csname figparam-ref#1\endcsname% get reference
  \ifx\thsr@f\relax
    \xdef\@r@f{\r@f}\else
    \xdef\@r@f{\thsr@f}\x@\global\x@\let\csname figparam-ref#1\endcsname\undefined% 
  \fi%
  \stripspace\@r@f\end/ \end/\relax\@r@f \edef\@r@f{\p@ram}% strip space
  \x@\let\x@\c@ption\csname figparam-caption#1\endcsname% get caption
  \ifx\c@ption\relax\let\c@ption\empty\else
    \x@\global\x@\let\csname figparam-caption#1\endcsname\undefined% 
  \fi
  \trace{g}{Fig caption#1: [\c@ption] \ifx\@r@f\empty\else(\@r@f)\fi}%
  \ifx\c@ption\empty\else
    \bgroup
    \ifx\cpt@mp\empty\else\setLRspecific\fi
    \edef\@@r@f{\ifx\@r@f\empty\else\DecorateRef{\@r@f\unskip}\fi}%
    \t@xtfragment{fig}{%
      \s@tfont{fig}{fig}%
      \ifCaptionRefFirst\@@r@f\nobreak\ \fi
      \c@ption\unskip
      \ifCaptionRefFirst\else\nobreak\ \@@r@f\fi}%
    \egroup
  \fi
}    

\newif\ifDoCaptions
\DoCaptionstrue

\def\d@caption{% 
  \ifDoCaptions
    \xdef\r@f{\csname figparam-ref\endcsname}% get reference
    \d@c@ption{}%Normal monoglot caption.
    \ifdiglot 
      \bgroup %Alternative captions
        \def\col@do##1{\def\c@rrdstat{##1}\d@c@ption{##1}}%
        \x@\each@col\diglot@list\E
      \egroup
    \fi
    \vskip.5\baselineskip
  \fi
}

\def\t@xtfragment#1#2{\bgroup\everypar={}\let\par\endgraf
    \leftskip=0pt plus \hsize \rightskip=\leftskip \parfillskip=0pt
    \getp@ram{justification}{#1}{#1}%
    \ifx\p@ram\r@ght\rightskip=0pt\fi
    \ifx\p@ram\l@ft\leftskip=0pt\fi
    \getp@ram{leftmargin}{#1}{#1}%
    \ifx\p@ram\relax \else \advance \ifRTL\rightskip\else\leftskip\fi\p@ram \IndentUnit \fi
    \getp@ram{rightmargin}{#1}{#1}%
    \ifx\p@ram\relax \else \advance \ifRTL\leftskip\else\rightskip\fi\p@ram \IndentUnit \fi
    \linepenalty=1000
    \s@tbaseline{#1}{#1}%
    \noindent\leavevmode #2\par
    \egroup
}
%-cfig_docaption
%+cfig_addcredit
\newdimen\FigCreditPadding
\FigCreditPadding=2pt
\def\add@credit{% Box to add credit to is  \newpicb@x
  \ifx\cr@ditpos\empty
    \edef\cr@ditpos{ti}% Center, inner edge
  \fi
  \x@\p@rseLoc\cr@ditpos\end
  \edef\cred@v{\l@cspec@a}\edef\cred@h{\l@cspec@b}%
  \trace{g}{creditrot="\cr@ditrot"}%
  \ifx\cr@ditrot\empty % Set some kind of a defaults
    \ifx\cred@h\@lignLeft
      \edef\cr@ditrot{-90}
    \else
      \ifx\cred@h\@lignRight
	\edef\cr@ditrot{90}
      \else
	\edef\cr@ditrot{0}%
      \fi
    \fi
    \trace{g}{credit rotation blank, \cr@ditrot deg chosen}%
  \fi
  % Positioning of credit box.
  \def\pr@credit{}\def\p@stcredit{}\def\ab@vecredit{}\def\b@lowcredit{}%
  \ifx\@lignLeft\cred@h\def\p@stcredit{\hfill}%
  \else\ifx\@lignRight\cred@h\def\pr@credit{\hfill}%
    \else\def\pr@credit{\hfill}\def\p@stcredit{\hfill}\fi
  \fi
  \ifx\@lignTop\cred@v\def\b@lowcredit{\vfill}%
  \else\ifx\@lignBot\cred@v\def\ab@vecredit{\vfill}%
    \else\def\b@lowcredit{\vfill}\def\ab@vecredit{\vfill}\fi
  \fi
  %
  %\trace{g}{Parse credit box}%
  \let\cr@dit@col\empty
  \edef\cr@ditstyle{x-credit|fig}%
  \ifx\cr@ditbox\empty\else
    \ifx\cr@ditbox\tru@\else
      \expandafter\p@rseCreditBox \cr@ditbox - - - \end\relax%
    \fi
    \ifx\cr@ditbox\tru@
    \else
      \edef\cr@ditstyle{x-credit:box=\cr@ditbox|fig,\cr@ditstyle}%
    \fi
  \fi
  % Determine if the credit (as a full line) is wider or taller, and whether it should be treated as a paragraph or a 
  % small piece of text.
  \count255=\cr@ditrot % adjust to -180 to 180 range.
  \loop
    \ifnum \count255>180 \advance\count255 by -360 \repeat
  \loop
    \ifnum \count255<-180 \advance\count255 by 360 \repeat
  \edef\@ngle{\the\count255}%
  \ifnum \count255>0
     \def\r@tSet{\kern\ht0}%
  \else 
     \def\r@tSet{\kern\dp0}%
     \count255=-\count255
  \fi
  %pad credit
  \setbox0=\hbox{\s@tfont{\cr@ditstyle}{\cr@ditstyle}\cr@dit}%
  \dimen1=\ht0\advance\dimen1 by \FigCreditPadding\ht0=\dimen1
  \dimen1=\dp0\advance\dimen1 by \FigCreditPadding\dp0=\dimen1
  % Calculuate maximum credit width.  (note count255 is now
  % positive)
  \ifnum \count255>45
    \ifnum \count255<135
       \dimen0=\ht\newpicb@x
    \else
       \dimen0=\wd\newpicb@x
       \def\r@tSet{}%
    \fi
  \else
    \dimen0=\wd\newpicb@x
  \fi
  \advance\dimen0 by -2\FigCreditPadding
  \ifdim\wd0>0.9\dimen0% Credit doesn't comfortably fit on one line. Find out how many it'll take
     \count255=2
     \loop
       \dimen1=\wd0
       \divide\dimen1 by \count255
       \ifdim \dimen1>\dimen0 \advance\count255 by 1 \repeat 
     \advance \dimen1 by \ht0 %Add ~1em to each line as line breaking space
     \ifdim \dimen1>\dimen0
       \dimen1=\dimen0
     \fi
     % Now cram the text into a box that ought to be just wide enough
     \setbox0=\vbox{\hsize=\dimen1\relax\t@xtfragment{\cr@ditstyle}{\vrule width 0pt height\ht0 \unhbox0\vrule depth\FigCreditPadding width 0pt}}%
  \fi
  \setbox0=\hbox{\hskip \FigCreditPadding\box0\hskip \FigCreditPadding}%
  \ifx\cr@ditbox\empty\else
    \ifx\cr@dit@col\empty
      \getp@ram{background}{\cr@ditstyle}{\cr@ditstyle}%
      \ifx\p@ram\relax
        \edef\cr@dit@col{1 1 1} 
      \else
	\ifx\p@ram\h@phen
          \edef\cr@dit@col{\p@ram}%
	\else
          \trace{g}{decoding \p@ram}%
          \x@\checkh@x \p@ram\end
          \let\cr@dit@col\rgb@out
          \trace{g}{ result: \cr@dit@col}%
          %\edef\cr@dit@col{\p@ram}%
	\fi
      \fi
    \fi
    \trace{g}{credit text on \cr@dit@col background}%
    \ifx\cr@dit@col\h@phen\else
      \setbox0=\hbox{\colourbox{\cr@dit@col}{}{\the\wd0}{\the\dp0}{\the\ht0}{0pt}{\box0}\relax}%
    \fi
  \fi
  \ifnum\cr@ditrot=0 \else
    \ifnum\count255>135 
      \setbox0=\hbox{\rot@tebzoneeighty}%
    \else
      \setbox0=\hbox{\rot@tebz}%
    \fi
  \fi
  \trace{g}{credit text is \the\wd0 x (\the\ht0 + \the\dp0)}%
  \setbox0=\vbox to \ht\newpicb@x{\baselineskip=0pt \hsize=\wd\newpicb@x \vskip 0pt\ab@vecredit\hbox to \wd\newpicb@x{\beginL\hskip 0pt\pr@credit\box0\p@stcredit\hskip 0pt\endL}\b@lowcredit\vskip 0pt}%
  \setbox\newpicb@x=\vbox to \ht\newpicb@x{\box\newpicb@x\vss\box0}%
}
\def\strip@minus#1-{#1}
\def\p@rseCreditBox#1 #2 #3 #4\end{%
  \trace{g}{credit box params "#1" "#2" "#3" "#4"}%
  \def\t@mp{- - }\def\tmp{#4}\ifx\tmp\t@mp
     \edef\cr@dit@col{\strip@minus #1 #2 #3}%
  \else
     \def\t@mp{t-}\def\tmp{#1}\ifx\tmp\t@mp
     	\let\cr@ditbox\tru@
     \fi
  \fi
}
%-cfig_addcredit
%+cfig_hex
\def\checkh@x #1#2\end{%
  \def\t@mp{#1}%
  \ifx \t@mp\@x@\x@\h@xsixtotripple #1#2\end\else\def\rgb@out{#1#2}\fi}

\def\h@xsixtotripple x#1#2#3#4#5#6\end{%
 \uppercase\x@{\def\rgb@out{%
   \x@\strip@pt\x@{\x@\dimexpr "#1#2 pt / 255}
   \x@\strip@pt\x@{\x@\dimexpr "#3#4 pt / 255}
   \x@\strip@pt\x@{\x@\dimexpr "#5#6 pt / 255}}}}
         
\setp@ram{fontsize}{x-credit|fig}{7}
%-cfig_hex

\def\m@kepl@ceholder#1#2#3{%
\vbox to #2{\offinterlineskip
  \trace{g}{makeplaceholder #3}%
  \hrule height .2pt \kern-.2pt
  \hbox to #1{\vrule height #2 width .2pt \hfil \vrule width .2pt}%
  \vbox to 0pt{\kern-#2 \vss \hbox to #1{\hss\idf@nt #3\hss}\vss}%
  \kern-.2pt \hrule height .2pt}}

\def\ins@rtpic#1#2#3#4#5#6#7{%
 \trace{g}{ins@rtpic #1 #7 #2 #3 (#4) #5 #6}%
 \openin\t@stread=#1
   \ifeof\t@stread\dimen0=\ifdim #3>#4\relax #4\else #3\fi
     \m@kepl@ceholder{\dimen0}{0.618 \dimen0}{missing: #1}%  \csname figparam-src\endcsname
   \else \closein\t@stread \picfilecomm@nd #1 #7 #2 #3 #5 #6\fi
}

\oddc@tcodes%NO SPACES until |normalc@tcodes is called.
|def|ch@ckpathfwd#1/#2|E{|edef|t@mp{#2}|ifx|t@mp|empty|else|global|temptrue|fi}
|def|ch@ckpathback#1\#2|E{|edef|t@mp{#2}|ifx|t@mp|empty|else|global|temptrue|fi}%
|def|ch@ckpath#1{|global|tempfalse|ch@ckpathfwd#1/|E|ch@ckpathback#1\|E}%
|normalc@tcodes%
%+cfig_dofigure_intro
\def\d@figure#1{%
 \trace{g}{d@figure entered IncludeFigures\ifIncludeFigures true\else false\fi}%
 \ifIncludeFigures
  \ifdim\hsize=0pt
    \hsize=\colwidth
  \fi
  \trace{g}{In d@figure #1 (hsz=\the\hsize)}\usfmthreefalse
  \rotimagefalse
  \edef\hs@ze{\the\hsize}% Current col size
  \gdef\p@rams{#1|}% ensure there is a trailing | separator
  % place parts of text into \param-1, \param-2, ...
  \global\p@ramnumber=1
  \loop
    \morep@ramstrue
    \s@tp@ramid% Sets morep@ramsfalse if off the end.
    \x@\gdef\csname figparam-\p@ramid\endcsname{}%
    \global\advance\p@ramnumber by 1
    \ifmorep@rams \repeat
    %\ifnum\p@ramnumber<12\repeat
  \global\p@ramnumber=1
  \loop
    \x@\getonep@ram\p@rams\end
    \ifx\p@rams\empty \morep@ramsfalse \else \morep@ramstrue \fi
    \ifmorep@rams\repeat
  %\ifusfmthree\x@\edef\csname param-caption\endcsname{\csname param-1\endcsname}\fi
  % get size
  \lowercase{\edef\size@ption{\csname figparam-size\endcsname}}%
  \lowercase{\edef\sizem@ltiple{\csname figparam-scale\endcsname}}%
  \expandafter\p@rsesize\size@ption**\end % extract possible multiplier
  % figparam-loc is ambiguously used, as either pgpos or media or something else.
  \x@\ifx\csname figparam-loc\endcsname\empty\else
    %if there's no -pgpos, assume that the (ambiguous) -loc parameter got used
    \x@\ifx\csname figparam-pgpos\endcsname\empty
      \x@\xdef\csname figparam-pgpos\endcsname{\csname figparam-loc\endcsname}%
      \x@\xdef\csname figparam-loc\endcsname{}%
    \else
      \x@\ifx\csname figparam-media\endcsname\empty
	\x@\xdef\csname figparam-media\endcsname{\csname figparam-loc\endcsname}%
	\x@\xdef\csname figparam-loc\endcsname{}%
      \fi
    \fi 
  \fi
  % get location
  \edef\loc@ption{\csname figparam-pgpos\endcsname}%%
%-cfig_dofigure_intro
  %
%+cfig_dofigure_1
  \ifx\loc@ption\empty % if location empty
    \ifx\size@ption\size@SPAN%
	   \def\loc@ption{t}% if size is SPAN default to top
	\else\def\loc@ption{tl}\fi % else default to top left FIXME? Standard says inline. Could swap to h if that proves stable.
  \fi
  % set width to column width or span width and other default parameters
  \p@cwidth=\textwidth \advance\p@cwidth by -\columnshift
  \p@cheight=\textheight
  \advance\p@cheight by -4\baselineskip % there should be text on the page too - allow for caption+space+2 lines of text!
  \picUsesInstrue \picNarrowfalse                                               %(1)
  \gdef\pic@lign{c}% How does the picture align within the box?
  \gdef\picV@lign{c}% How does the picture align vertically on the page (Page/Full only)
  \gdef\picl@c{}% location code for in-line (non-insert) pictures
  % By default, set the insert width to full span
  \p@cinswid=\textwidth\advance\p@cinswid by -\columnshift
  \ifx\size@ption\size@COL \p@cwidth=\hsize
  \else\ifx\size@ption\size@SPAN
    \else\ifx\size@ption\size@PAGE
        \global\let\picl@c=\loc@Page
        \picUsesInsfalse
        \p@cheight=\textheight % without text
        \advance\p@cheight by -2\baselineskip
      \else\ifx\size@ption\size@FULL
          \global\let\picl@c=\loc@Full
          \picUsesInsfalse
          \p@cwidth=\PaperWidth\p@cheight=\PaperHeight
          \p@cinswid=\PaperWidth
        \else
           \errmessage{Unknown picture size "\size@ption", expected "col", "span", "page" or "full"}\fi\fi\fi\fi
  \let\p@cins=\relax
%-cfig_dofigure_1
  % --------- Parse the location option -----------
%+cfig_dofigure_2
  \global\advance\im@gecount by 1
  \x@\let\x@\pgn@\csname fig\the\im@gecount p@ge\endcsname                    %(1)
  \ifx\pgn@\relax
    \whichp@ge=\pageno
    \trace{g}{Picture \the\im@gecount may not be mirrored/rotated/aligned properly}%
  \else
    \whichp@ge=\pgn@
    \trace{g}{Picture \the\im@gecount was on page \pgn@ last time. [\the\pageno]}%
  \fi
  \let\w@tsit\gr@phic   % Make sure the debugging info is correct. Also, tested for sometimes 
  \x@\p@rsePicUse\loc@ption\end                                               %(2)
  % make \p@cins point to insertion class for this location
  \otherinsht=0pt % subtract this from the insert height.
  \ifx\loc@ption\loc@T \let\p@cins=\topins
  \else
    \ifx\loc@ption\loc@B \let\p@cins=\bottomins
    \else
      \ifdiglot %For diglot, need to know the height of the tallest insert
        \ifx\l@cspec@a\loc@T %(Only affects top)
          \let\col@do=\max@boxht \dimen1=0pt
          \edef\v@lpfx{\colinsert@name{t}}\def\v@lsfx{}%
          \x@\each@col\diglot@list\E
          \uppercase{\def\t@mp{\l@cspec@b}}%
          \ifx\t@mp\m@x@at@col\else %don't adjust height if this box is already highest
            \otherinsht=\dimen1
          \fi
        \fi
      \fi
      \ifnum\c@rrentcols>1
        \ifx\l@cspec@a\loc@T
          \p@cinswid=\hsize
        \else\ifx\l@cspec@a\loc@B
          \p@cinswid=\hsize
        \fi\fi
      \else
        \ifdiglot\MSG{HOW DID THAT HAPPEN? c@rrentcols=\the\c@rrentcols\space is surprising(incorrect) with diglot}\fi
        \ifx\loc@ption\loc@TL \picw@rning{tl}{t}\let\loc@ption\loc@T
        \else\ifx\loc@ption\loc@TR \picw@rning{tr}{t}\let\loc@ption\loc@T
        \else\ifx\loc@ption\loc@BL \picw@rning{bl}{b}\let\loc@ption\loc@B
        \else\ifx\loc@ption\loc@BR \picw@rning{br}{b}\let\loc@ption\loc@B
        \fi\fi\fi\fi
      \fi
  \fi\fi
  \ifpicUsesIns
    \x@\let\x@\p@cins\csname ins-\loc@ption\endcsname
    \ifx\p@cins\relax
      \x@\let\x@\p@cins\csname \colinsert@name{\loc@ption}\endcsname
      \ifx\p@cins\relax
        \message{Unknown picture location "\loc@ption",
          expected one of t,b,tl,tr,bl,br,tL,tR,bL,bR or an inline one}%
        \ifnum\c@rrentcols>1
          \p@cinswid=\hsize
          \iffiglocleft\let\p@cins=\topleftins\figlocleftfalse \otherinsht=\ht\toprightins
          \else\let\p@cins=\toprightins\figloclefttrue \otherinsht=\ht\topleftins\fi
        \else \let\p@cins=\topins\fi
      \else
        \ifdiglot
          \x@\let\x@\tmp\csname column\l@cspec@b width\endcsname
          \ifx\tmp\relax\else
            \p@cinswid=\tmp
          \fi
        \fi
      \fi
    \fi
  \fi
  \ifdiglot\else\otherinsht=0pt \fi %Nothing to subtract if not diglot
  \ifdim\p@cinswid<\p@cwidth
    \message{*** Picture \the\p@cwidth\space wide in  \the\p@cinswid\space space. \ifx\size@ption\size@SPAN Did you mean to use col, instead of span?\fi}%
  \fi
%-cfig_dofigure_2
  % create box to contain picture
%+cfig_dofigure_3
  \ifcsname figparam-x-spacebeside\endcsname
    \x@\let\x@\sp@cebeside\csname figparam-x-spacebeside\endcsname%
    \ifx\sp@cebeside\empty
      \edef\sp@cebeside{\DefaultSpaceBeside}%
    \fi
  \else
    \edef\sp@cebeside{\DefaultSpaceBeside}%
  \fi
  \trace{g}{Figure \the\im@gecount\space size=\size@ption, scale=\sizem@ltiple, loc=\loc@ption \ifpicUsesIns, picins=\the\p@cins\fi, hsz=\the\hsize}%
  \setbox0=\vbox{%
    \ifpicNarrow
      \hsize=\sizem@ltiple\p@cwidth
      \p@cinswid=\hsize
    \else
      \hsize=\p@cinswid
    \fi
    \ifCaptionFirst\d@caption\else
      \tempfalse
      \ifpicUsesIns\temptrue\fi
      \ifx\picl@c\loc@Inl\temptrue\fi
      \ifx\picl@c\loc@Par\temptrue\fi
      \ifx\picl@c\loc@Cut\temptrue\fi
      \iftemp 
        \vskip0.3\baselineskip
      \fi
    \fi
	% insert picture based on PicPath and file name, scaled to \p@cwidth
    \let\picfilecomm@nd=\XeTeXpicfile
    \edef\f@lename{\csname figparam-src\endcsname}%
    \edef\mirr@r{\csname figparam-mirror\endcsname}%
    \def\xtra{}\def\xtraremains{}%
    \expandafter\ch@ckpdf\f@lename..\endf@lename
    \let\picp@ge\empty
    \x@\p@rsextra{\csname figparam-x-xetex\endcsname}%See if there are any key=val parameters in the x-xetex parameter
    %what are we scaling on the image? Width or height?
    \ifrotimage
      %If there's rotation, fit the image height to width instead of the normal way:
      \def\picdim@n{height}\def\picaltdim@n{width}%
    \else
      \def\picdim@n{width}\def\picaltdim@n{height}%Normal
    \fi
    % First, try to set it at the requested dimension:
    \tempfalse
    \x@\ch@ckpath\x@{\f@lename}
    \iftemp
      \setbox\newpicb@x=\hbox{%
        \ins@rtpic{"\csname figparam-src\endcsname"}%
                     {\picdim@n}{\the\dimexpr\sizem@ltiple\p@cwidth\relax}{\the\dimexpr\p@cheight\relax}{\xtra}{\xtraremains}{\picp@ge}}%
    \else
      \setbox\newpicb@x=\hbox{%
        \ins@rtpic{"\the\PicPath\csname figparam-src\endcsname"}%
                     {\picdim@n}{\the\dimexpr\sizem@ltiple\p@cwidth\relax}{\the\dimexpr\p@cheight\relax}{\xtra}{\xtraremains}{\picp@ge}}%
    \fi
    \ifdim\ht\newpicb@x>\p@cheight
      %It doesn't fit. Scale to other dimension:
      \trace{g}{Picture too big set with \picdim@n=\sizem@ltiple\space\the\p@cwidth}%
      \setbox\newpicb@x=\hbox{%
        \ins@rtpic{"\the\PicPath\csname figparam-src\endcsname"}%
                     {\picaltdim@n}{\p@cheight}{\sizem@ltiple}{\xtra}{\xtraremains}{\picp@ge}}%
    \fi
    \ifFigurePlaceholders % replace graphic with a frame and the file name
      \setbox\newpicb@x=\m@kepl@ceholder{\wd\newpicb@x}{\ht\newpicb@x}{\csname figparam-src\endcsname}%
    \fi
    \trace{g}{Object going into hbox \sizem@ltiple x \the\p@cwidth}%
    \setbox\newpicb@x=\hbox to \sizem@ltiple\p@cwidth{\hss
      \edef\l@gstring{{\the\im@gecount}{\f@lename}{\csname figparam-pgpos\endcsname}{\csname figparam-copy\endcsname}{\picdim@n:\the\wd\newpicb@x x\the\ht\newpicb@x}}% Fully expand figure parameters, but leave page no. to be expanded later.
      \x@\writefigp@gelog\x@{\l@gstring}%
      \box\newpicb@x\hss}%
%-cfig_dofigure_3
    % FIXME: Something like this?
%+cfig_dofigure_4
    \tempfalse
    \def\pr@pic{}\def\p@stpic{}%
    \ifx\mirr@r\empty\else
      \trace{g}{Mirror: \mirr@r, \the\pageno}%
      \global\def\pr@pic{%
         \trace{g}{prepic: Mirror: \mirr@r, \the\pageno}%
         \ifx\mirr@r\val@dd\ifodd\whichp@ge\temptrue\fi\fi %Page number is frequently low by one or 2 when image is read. Needs external toc-style file.
         \ifx\mirr@r\val@ven\ifodd\whichp@ge\else\temptrue\fi\fi
         \ifx\mirr@r\valb@th\temptrue\fi
         \iftemp\trace{g}{Mirrored image requested}%
           \dimen0=\wd\newpicb@x\kern\dimen0\special{pdf:  begintransform}\special{x:scale -1 1}\fi
      }%
      \global\def\p@stpic{\iftemp\special{pdf: endtransform}\kern-\dimen0\fi
      }%
      \setbox\newpicb@x\hbox{\pr@pic\box\newpicb@x\p@stpic}%
    \fi
    %
    \x@\ifx\csname figparam-x-credit\endcsname\empty\else
        \x@\let\x@\cr@dit\x@=\csname figparam-x-credit\endcsname 
	\x@\let\x@\cr@ditpos\x@=\csname figparam-x-creditpos\endcsname
	\x@\let\x@\cr@ditrot\x@=\csname figparam-x-creditrot\endcsname
	\x@\let\x@\cr@ditbox\x@=\csname figparam-x-creditbox\endcsname
	\add@credit%
    \fi
    %Align image left/right or centre
    \trace{g}{Object aligned into hbox \the\p@cinswid}%
    \ifx\pic@lign\@lignRight\hbox to \p@cinswid{\hss\box\newpicb@x}%
    \else
      \ifx\pic@lign\@lignLeft \hbox to \p@cinswid{\box\newpicb@x\hss}%
      \else\hbox to \p@cinswid{\hss\box\newpicb@x\hss}\fi
    \fi
    \ifCaptionFirst\vskip 0.5\baselineskip\else\d@caption\fi
  }% END of box0
  \trace{g}{Picture height=\the\ht0, vs:\the\vsize, \the\partialLpenalty,  pg:\the\pagegoal, pt:\the\pagetotal, av:\the\availht, aligned:\pic@lign}%
%-cfig_dofigure_4
%+cfig_dofigure_5
  \trace{b}{BALANCE fig: height=\the\ht0: baselineskip=\the\baselineskip}%
  % insert into proper insertion class for this position
  \ifpicUsesIns
    \trace{g}{Picture (\the\ht0,\the\dp0) goes to insert}%
    \ifdiglot
      \trace{g}{Other side: \the\otherinsht.}%
      \ifdim\ht0<\otherinsht
        \ht0=0pt
      \else
        \advance\otherinsht by -\ht0 %can't do maths on \ht0, need to calculate backwards
        \ht0=-\otherinsht
      \fi
    \fi
    \trace{g}{Picture now \the\ht0 \space into insert box \the\p@cins}%
    \insert\p@cins{\penalty10000 % make sure this picture does not float away to another page
      \splittopskip\z@skip
      \splitmaxdepth\maxdimen \floatingpenalty20000 % was zero
      \headingtopspace=0pt%
      \penalty10000
      \pdfsavepos\penalty10000
      \write\p@rlocs{\noexpand\@nontextstart{\the\pdflastxpos}{\the\pdflastypos}}\penalty10000%
      \gridp@ctrue\gridb@x0\gridp@cfalse% make sure we align to the page grid
      \pdfsavepos
      \write\p@rlocs{\noexpand\@nontextstop{\the\pdflastxpos}{\the\pdflastypos}}%
    }%
%-cfig_dofigure_5
%+cfig_dofigure_6
  \else
    % Calculate lines used for the picture
    \dimen0=\ht0 \advance\dimen0 by \dp0 %
    \count255=\dimen0
    \divide\count255 by \baselineskip
    \advance\count255 by 1
    \dimen2=\count255\baselineskip %space reserved...
    \trace{g}{Inline \w@tsit\space takes \the\dimen0, reserving \the\dimen2}%
    %
    \ifx\picl@c\loc@Inl
      \d@figureInl 0%
    \fi
    %
    \ifx\picl@c\loc@Par
      \d@figurePar 0%
    \fi
    %
    \ifx\picl@c\loc@Page
      \d@figurePage 0%
    \fi
    \ifx\picl@c\loc@Full
      \d@figureFull 0%
    \fi
    \ifx\picl@c\loc@Cut
      \d@figureCut 0%
    \fi
    %Sanity check. If we used \box0 then it'll be empty now.
    \ifvoid0\else\message{Placement for \the\im@gecount could not be understood. Image Lost!}\fi
   \fi
 \fi% end \ifIncludeFigures
}


\def\@lignpic#1{%Align pic (or whatever) according to pic@lign
  \def\l@ftedge{\hss}\def\r@ghtedge{\hss}%
  \ifx\pic@lign\@lignLeft\def\l@ftedge{}\fi
  \ifx\pic@lign\@lignRight\def\r@ghtedge{}\fi
  \ifRTL\let\t@mp\r@ghtedge\let\r@ghtedge\l@ftedge\let\l@ftedge\t@mp\fi
  \setbox#1\vbox{\hbox to \p@cinswid{\l@ftedge\box#1\r@ghtedge}}%
}
\def\d@figureInl#1{%
  \trace{g}{\w@tsit\space is inline, \the\hsize \ifhmode , in HMODE\fi \ifpicNarrow , narrow\fi}%
  \penalty10 % Allow the page to break
  \ifpicNarrow
    \@lignpic{#1}%
  \fi
  %\splittopskip\baselineskip
  \def\picc@ntents{%
    \gridp@cfalse% Not true! It's not floating.
      \headingtopspace=0pt
    \trace{g}{Before gridbox \the\ht#1+\the\dp#1}%
    \gridb@x#1%
    \ifx\w@tsit\gr@phic
      \dimen9=\lastdepth \kern\dimen9
      \trace{g}{gridbox dp=\the\dimen9}%Figs have a skip at the bottom of the box, but somehow the depth is kept. Need to kill it. sidebars don't have this issue.
    \fi
  \penalty10}%
  \ifvmode \picc@ntents
  \else\vadjust pre{\picc@ntents}\fi
}


\def\d@figurePar#1{%
  \trace{g}{\w@tsit is post-paragraph, \the\hsize/\the\p@cinswid \ifpicNarrow , narrow\fi}%
  \x@\let\x@\picb@@x\csname picb@x\g@tdstat\endcsname
  \global\setbox\picb@@x\box#1%
  \ifpicNarrow
    \@lignpic{\picb@@x}%
    %\ifx\pic@lign\@lignLeft \global\setbox\picb@@x\vbox{\hbox to \colwidth{\box\picb@@x\hss}}\trace{g}{Pic aligned left}%
    %\else \global\setbox\picb@@x\vbox{\hbox to \colwidth{\hss\box\picb@@x}}\trace{g}{Pic aligned right}%
    %\fi
    %\showbox\picb@@x
  \fi
  \edef\eotpn@me{at@ndofthispar\c@rrdstat}% Which at@ndofthispar macro?\emspace
  \trace{g}{\eotpn@me\space defined}%
  \x@\gdef\csname \eotpn@me\endcsname{%
    \relax \x@\let\x@\picb@@x\csname picb@x\g@tdstat\endcsname
    \penalty10 % Allow the page to break
    %\gridp@cfalse% Not true. Not a floating image.
      \headingtopspace=0pt
      %\vskip-\prevdepth
      \gridb@x\picb@@x
      \prevdepth=0pt
      \penalty10
   }%
   \def\temp{}%
   \ifnum\c@tskip>1 \count255=\c@tskip
     \loop\ifnum\count255>1
       \edef\temp{D|\temp}\advance\count255 by -1
     \repeat
   \fi
   \trace{g}{Delay for \eotpn@me set to '\temp'}%
   \x@\xdef\csname \eotpn@me Delay\endcsname{\temp}%
   \relax\relax
}
%-cfig_dofigure_6
%+cfig_dofigure_7

\def\d@figurePage#1{%
  \d@figurep@ge{#1}{page}{\textheight}{11}{0pt}%
}
\def\d@figureFull#1{%
  \d@figurep@ge{#1}{full-page}{\PaperHeight}{9}{\FullPageFudgeFactor}%
  %\showbox\wholepagepic
}

% #1 box, #2 type, #3 vertical size, #4 magic penalty, #5 fine tuning kern 
\def\d@figurep@ge#1#2#3#4#5{%
  \trace{g}{\w@tsit\space is #2, \the\ht#1, \the\wd#1}%
  \dimen0=#3 \advance\dimen0 by -\ht#1
  \advance\dimen0 by -\dp#1
  \divide\dimen0 by 2
  \ifx\picV@lign\@lignTop \trace{g}{V alignment: top}\setbox#1\vbox{\vbox to #3{\kern#5\box#1\vss}}\else
    \ifx\picV@lign\@lignBot \trace{g}{V alignment: bottom}\setbox#1\vbox{\vbox to #3{\vss\box#1}}\else
      \ifx\picV@lign\@lignCent \trace{g}{V alignment: center}\setbox#1\vbox{\vbox to #3{\vss\box#1\vss}}\else
        \trace{g}{V alignment: none}\setbox#1\vbox{\vskip 0pt plus \the\dimen0 \penalty10000\box#1\penalty10000\vskip 0pt plus \dimen0}%
    \fi\fi\fi
  \global\setbox\wholepagepic\vbox{\unvbox\wholepagepic\unvbox#1\kern#4 sp\penalty 1}% magic number
}


\def\DefaultSpaceBeside{10pt}
\def\c@tskipparse#1.#2.#3\E{%
  \def\t@mp{#2}\ifx\t@mp\empty
    \gdef\c@tskipfrac{#1}%
  \else
    \xdef\c@tskipfrac{#1.#2}%
    \ifnum #2 < 5
      \xdef\c@tskip{#1}%
    \else
      \ifnum #1<0 
        \xdef\c@tskip{\the\numexpr #1  -1\relax}%
      \else
        \xdef\c@tskip{\the\numexpr #1  +1\relax}%
      \fi
    \fi
  \fi
  \trace{g}{cut skip is \c@tskip (\c@tskipfrac)}%
}

\def\d@figureCut#1{% Expects: count255=number of lines gap, \c@tskip=delay
  \mkstr@t
  \dimen0=\ht#1
  \ifx\w@tsit\gr@phic 
   \edef\dr@pthingid{droppic\the\im@gecount}%
  \else
   \global\advance\notim@gecount by 1
   \edef\dr@pthingid{drop\w@tsit\the\notim@gecount}%
   \x@\ifx\csname thisw@tsitslop\endcsname\relax\else
     \@@getCutoutSlop{\dr@pthingid}%
     \ifx\r@iselimit\relax
       \x@\setCutoutSlop\x@{\x@\dr@pthingid\x@}\thisw@tsitslop
     \fi
     \let\thisw@tsitslop\relax
   \fi
  \fi
  \trace{g}{\w@tsit\space\dr@pthingid\space is in a cutout. \the\count255 x \the\baselineskip.}%
  %\setbox#1=\hbox{\vrule height\dimen0\kern 0.5pt\box#1}%TESTING.
  \dimen1=-\baselineskip %where does the picture go? Starting point is the lowest point of the current line(i.e. this includes descenders, but we'll deal with that via the strutb@x)
  \advance\dimen1 by -\dp\str@tbox
  \ifhmode
     \trace{g}{Cutout in horizontal mode. ref:\ifdiglot\dc@rref\else\c@rref\fi}%
     \ifx\prev@rsemode\empty
       \trace{g}{we were in horizontal mode even before the verse number.}%
     %  \dimen1=0pt
     \else
       \trace{g}{Before this verse was started it was in vertical mode.}%
	%\ifdim\lastdepth>0pt
	  %\advance\dimen1 by -\lastdepth
	%\fi
     \fi
     %\csname\m@rker\endcsname
  \else
     \trace{g}{Cutout was in vertical mode.}%
     \leavevmode %needed for keyterm-based figures, at least
     \tmpcount=0
  \fi
  %\advance\dimen1 by \baselineskip
  \advance\dimen1 by \c@tskipfrac\baselineskip
  \dimen2=\wd#1\advance\dimen2 by \sp@cebeside\relax\dimen3=\hs@ze \advance\dimen3 by -\dimen2
  \ifdim\dimen3<5em\message{*** \w@tsit specification of \csname size@ption\endcsname \csname sizem@ltiple\endcsname (at \ch@pter:\v@rse) leaves \the\dimen3 \space for text. That's probably not enough.}\fi
  \raise@test{\dr@pthingid}%
  \ifx\t@str@ise\relax\else
    \advance\dimen1 by -\t@str@ise\baselineskip
  \fi
  \setbox#1\vbox to 0pt{\kern\dimen1\kern\count255\baselineskip\vbox to 0pt{\vss\box#1}\vss}%
  \advance\tmpcount by \c@tskip
  \ifx\l@cspec\@lignLeft
    \let\c@tcmd\leftcutout
    \edef\thing@side{L}%
    \setbox#1\hbox to \hsize{\box#1\hss}%
  \else
    \ifx\l@cspec\@lignRight
      \let\c@tcmd\rightcutout
      \edef\thing@side{R}%
      \setbox#1\hbox to \hsize{\hss\box#1}%
    \else
      \message{*** Unknown cutout position \l@cspec, picture misplaced}%
      \let\c@tcmd\rightcutout
      \edef\thing@side{R}%
      \setbox#1\hbox to \hsize{\hss\box#1\hss}%
    \fi
  \fi
  \delay@test{\dr@pthingid}%
  \ifx\t@std@lay\relax \MSG{*** Cutout for picture \the\im@gecount, (\ifdiglot\dc@rref\else\c@rref\fi) re-run to generate \string\DelayedItem\space setting}%
  \else\MSG{* Cutout for picture \the\im@gecount\space at \ifdiglot\dc@rref\else\c@rref\fi, delay is \t@std@lay}\fi
  %
  \ifx\t@std@lay\relax
    \tmpcount=0
  \else
    \tmpcount=\t@std@lay
  \fi
  %\ifhmode 2|\fi
  \write@delayedthing{\dr@pthingid}{\the\tmpcount}{\the\dimen2}{\the\count255}{\c@tskip}{\thing@side}%
  \ifx\t@std@lay\relax
    \MSG{*** Image in cutout at \ifdiglot\dc@rref\else\c@rref\fi, re-run to generate \string\DelayedItem\space settings}%
  \else\fi
  \add@pending{\dr@pthingid}{\ifdiglot\dc@rref\else\c@rref\fi}{0}{\the\dimen2}{\the\count255}{\the\tmpcount}{\thing@side}%
  \ifx\gr@phic\w@tsit
    \leavevmode\str@t\vadjust {\vbox to 0pt{\box#1\vss}}%
  \else
    \ifhmode \vadjust{\vbox to 0pt{\box#1\vss}}%
    \else 
        \vskip -1\baselineskip
       % \vrule height 0pt depth 1pt width 10ex\kern-1pt 
        \vbox to 0pt{\box#1\vss}%
    \fi
  \fi 
  \run@pending
    %\setbox#1\hbox to \hsize{\box#1\hss}%
    %\trace{g}{leftcutout \the\dimen2, \c@tskip, \the\count255}%
    %\leftcutout{\the\dimen2}{\the\coun254}{\the\count255}%
  %\else\ifx\l@cspec\@lignRight
      %\leavevmode\str@t\vadjust {\vbox to 0pt{\box#1\vss}}%
     %% \strut\vadjust pre{\box#1}%
      %\trace{g}{rightcutout \the\dimen2, \c@tskip, \the\count255}%\
  %\fi
}
%-cfig_dofigure_7

\newtoks\PicPath % directory containing picture files
\newif\ifIncludeFigures \IncludeFigurestrue
\newif\ifFigurePlaceholders
\newif\ifCaptionRefFirst % Does the reference come before or after the caption text?
\CaptionRefFirstfalse
\newif\ifCaptionFirst % Does the caption come before the image or after?
\CaptionFirstfalse
\def\FullPageFudgeFactor{0pt} % How much does a full page top-aligned picture miss the top of the page by?
%+cfig_checkpdf
\def\ch@ckpdf#1.#2.#3\endf@lename{\lowercase{\edef\@xt{#2}}%
  \ifx\@xt\@pdf \let\picfilecomm@nd\XeTeXpdffile \fi}
%-cfig_checkpdf

%+cfig_declare
\def\picw@rning#1#2{\msg{converted picture placement "#1" to "#2" in single-column layout}}
\x@\let\csname \gr@phic @warning\endcsname\picw@rning

\def\alias@inserts{%
  \x@\let\csname ins-\loc@TL\endcsname\topleftins
  \x@\let\csname ins-\loc@TR\endcsname\toprightins
  \x@\let\csname ins-\loc@BL\endcsname\bottomleftins
  \x@\let\csname ins-\loc@BR\endcsname\bottomrightins
  \x@\let\csname ins-\loc@T\endcsname\topins
  \x@\let\csname ins-\loc@B\endcsname\bottomins
  \x@\let\csname ins-\loc@VB\endcsname\verybottomins
}
\alias@inserts
\newbox\newpicb@x
\newbox\picb@x % Delayed picture
\newbox\picb@xR % (diglot, right-hand) delayed picture.
\newbox\wholepagepic
\newcount\p@ramnumber
\newcount\notim@gecount \notim@gecount=0
\newdimen\p@cinswid
\newdimen\p@cwidth
\newdimen\p@cheight
\newdimen\otherinsht % In a diglot, an insert doesn't affect availht if it's smaller

\newif\ifmorep@rams
\newif\ifpicp@gefile \picp@gefilefalse
\newread\picl@ctest
\newwrite\picp@ges
%-cfig_declare

%+cfig_openpicpages
\def\inputpicp@ges "#1"{%read picpages file.
    \openin\picl@ctest="#1" % test to see if the file exists before reading it.
    \ifeof\picl@ctest \let\n@xt=\relax
    \else \def\n@xt{\input "#1"}%
    \fi
    \closein\picl@ctest
    \n@xt
}

\def\openpicpages "#1"{%set up a .picpages file, and check for changes at the end of the run.
  \ifpicp@gefile\else
    \inputpicp@ges "#1"
    \picp@gefiletrue
    \addtoendhooks{\finishpicp@ges "#1"}%
    \openout\picp@ges="#1" % test to see if the file exists
  \fi
}
\def\l@stfignum{0}
\def\finishpicp@ges "#1"{\immediate\closeout\picp@ges % close the picpages file, then re-read it and check for changes
   \tempfalse
   \trace{g}{lastfignum was \l@stfignum, count now:\the\im@gecount}%
   \ifnum\im@gecount=\l@stfignum\else
     \temptrue
     \trace{g}{Number of images has changed}%
   \fi
   \let\figonpage=\checkfigpage
   \let\labelonpage=\checklabelpage
   \inputpicp@ges "#1"
   \iftemp\message{}\message{*** Figures have changed. It may be necessary to re-run the job}\fi%
}

\def\writefigp@gelog#1{%
  \write\picp@ges{\string\figonpage{\the\pageno}#1}%
  \x@\ifx\csname tr@cemode-gI\endcsname\y@s\immediate\write-1{Figure: #1}\fi
}

%: `\figonpage` gets written to the picpages auxiliary file at insert use.
% #1 ~ Page number
% #2 ~ Figure number
% #3 ~ File name
% #4 ~ pgpos parameter
% #5 ~ Copyright info from \fig line
% #6 ~ Anything else that might affect page breaking or alignment (e.g. size, rotation)
\def\figonpage#1#2#3#4#5#6{\x@\gdef\csname fig#2p@ge\endcsname{#1}%Page number
\x@\gdef\csname fig#2p@ram\endcsname{#3#4#6}% Any other parameters that might affect page-breaking.
  \ifnum\l@stfignum>#2 \else
    \xdef\l@stfignum{#2}%
  \fi
%\trace{P}{Picture "#3" turned up on page #1}%
}%
\def\checkfigpage#1#2#3#4#5#6{%
  \edef\ch@ck{#3#4#6}%
  \trace{g}{Comparing "\ch@ck" with "\csname fig#2p@ram\endcsname"}%
  \x@\ifx\csname fig#2p@ram\endcsname\ch@ck\else\trace{g}{Figure #2 parameters changed}%
   %\temptrue %Probably don't matter on their own, but could change pagination. Significant pagination changes should be caught by other tests.
  \fi
  \edef\ch@ck{#1}%
  \x@\ifx\csname fig#2p@ge\endcsname\ch@ck\else\trace{g}{Figure #2 page changed from \ch@ck \space to \csname fig#2p@ge\endcsname}\temptrue\fi
  \x@\let\x@\ch@ck\csname fig#2occurrences\endcsname
  \ifx\ch@ck\relax\x@\edef\csname fig#2occurrences\endcsname{#1}\else
    \message{*** Figure #2 on page #1, but previously seen on \ch@ck. Work-around is to move the anchor to a different verse or alter the size/placement.}%
    \x@\edef\csname fig#2occurrences\endcsname{\ch@ck, #1}%
  \fi
}
%-cfig_openpicpages
%
%+cfig_dofigpage
\def\dofigp@ge{%
  \ifvoid\wholepagepic\else
    \trace{g}{wholepagepic is \the\ht\wholepagepic high}%
    %\tracingassigns=1
    \savingvdiscards=1
    %\nonstopmode\showbox\wholepagepic
    \setbox2=\copy\wholepagepic
    \setbox0=\vsplit\wholepagepic to \PaperHeight
    \tmpcountB=\badness
    \tempfalse
    \ifnum\tmpcountB>200 % Overstretch or understretch
      \temptrue
    \fi
    \setbox3=\vbox{\splitdiscards}%
    \setbox1=\vbox{\unvcopy3\unpenalty\global\tmpcount=\lastkern}%
    \setbox\wholepagepic=\vbox{\unvbox\wholepagepic}%
    \trace{g}{After split (\the\tmpcountB)  wholepagepic \the\ht\wholepagepic+\the\dp\wholepagepic}%
    \ifdim\ht\wholepagepic>0pt
      %\showbox3 \showbox\wholepagepic
      \setbox\wholepagepic=\vbox{\unvcopy1\unvbox\wholepagepic}%
    \else 
      \setbox\wholepagepic\box\voidb@x
    \fi
    %\showbox1
    %\showbox0
    \setbox0=\vbox{\unvbox 0\unpenalty\global\tmpcountB=\lastkern}% MUST do this unconditionally
    \trace{g}{lp: box0 is \the\ht0\space high, penalty:\the\tmpcount, \the\tmpcountB, th:\the\textheight, ph:\the\PaperHeight}%
    \ifnum\tmpcountB=0\else\tmpcount=\tmpcountB\fi % Because if processing in a box gets surprising.
    %\showbox0
    \ifnum\tmpcount=11% expected values: 11 (normal-sized page)
      \def\pagecontents{%
        \trace{g}{Topins=\the\ht\topins, Bottomins=\the\ht\bottomins, tlins=\the\ht\topleftins, blins=\the\ht\bottomleftins, trins=\the\ht\toprightins, brins=\the\ht\bottomrightins, hoffset=\the\hoffset, voffset=\the\voffset}%
        \vbox to \textheight{\par\unvbox0}%
        }%
      \plainoutput
    \else% Full page, past margins (9) or 0 
      \dimen9=\pdfpagewidth \dimen8=\pdfpageheight
      %\showbox 0
      \trace{g}{Topins=\the\ht\topins, Bottomins=\the\ht\bottomins, tlins=\the\ht\topleftins, blins=\the\ht\bottomleftins, trins=\the\ht\toprightins, brins=\the\ht\bottomrightins, hoffset=\the\hoffset, voffset=\the\voffset, PaperHeight=\the\PaperHeight, pdfpageheight=\the\pdfpageheight}%
      \setbox0\vbox to \PaperHeight{\unvbox0}%  
      \trace{g}{Box prepared (\the\ht0+\the\dp0)x\the\wd0}%
      \shipcompletep@gewithcr@pmarks{\box0}
      \pdfpagewidth=\dimen9 \pdfpageheight=\dimen8
      \advancepageno
    \fi
  \fi
  %\tracingassigns=0
  \let\n@xt\relax
  \ifdim\ht\wholepagepic>0pt
    \let\n@xt\dofigp@ge
  \fi
  \n@xt
}
\newtoks\onship@ut 
\def\addtonextshipout#1{\x@\global\x@\onship@ut\x@{\the\onship@ut #1}}
\def\nextshipout{\the\onship@ut\onship@ut{}\dofigp@ge}
%-cfig_dofigpage

