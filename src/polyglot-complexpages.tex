%:strip
% polyglot-complexpages.tex: multi-page polyglot processing for xetex paratext2.tex
% Copyright (c) 2025 by SIL International 
% written by David Gardner
% 
% This optional plugin (see ptx-plugins) extends the basic diglot engine to
% provide complex, multipage polyglot options. There is no synchronisation across pages.
%
% Permission is hereby granted, free of charge, to any person obtaining
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\plugin@startif{polyglot-complexpages}
\plugins@needed{polyglot-simplepages} % 

\def\new@followon#1{%
  \count255=`Z
  \advance\count255 -63 % We know it'll be reduced by 1 later on...
  \edef\s@ffix{#1}%
  \loop% Get to the last f@llow@n of the parent
    \tempfalse\ifcsname f@llow@n\s@ffix\endcsname
      \x@\let\x@\tmp\csname f@llow@n\s@ffix\endcsname\ifx\tmp\undefined\else\ifx\tmp\empty\else
        \let\s@ffix\tmp
        %\trace{dmc}{tmp is \tmp}%
        \count255=\x@`\s@ffix
        \advance\count255 -64
        \temptrue
      \fi\fi
    \fi
  \iftemp\repeat
  \trace{dmc}{Last in #1 chain is \s@ffix}%
  \advance\count255 -1
  \edef\x@fch@r{\@Alph{\count255}}%
  \@new@followon{#1}{\s@ffix}% x@fch@r is passed implicitly
} 
 
\def\@new@followon#1#2{% source, following-on. x@fch@r provides the character
  \trace{dmc}{@new@followon #1 #2 \x@fch@r}%
  %\tracingmacros=1 \tracingcommands=1 \tracingassigns=1
  \temptrue
  \ifcsname \x@fch@r isDiglotColumn\endcsname\tempfalse\fi
  \ifcsname \x@fch@r isFollowOn\endcsname
    \def\tmp{#1}%
    \x@\let\x@\tmpb\csname f@llowing\x@fch@r\endcsname
    \trace{dmc}{\x@fch@r\space is following \tmpb}% 
    \ifx\tmp\tmpb
      \trace{dmc}{Follow-on for \x@fch@r\space is \csname f@llow@n\x@fch@r\endcsname, but it's not in the current chain.}% So we can ignore that fact.
      %\x@\ifx\csname f@llow@n\x@fch@r\empty\else
        %\tempfalse
      %\fi 
    \else
      \tempfalse
    \fi
  \fi
  \iftemp
    \trace{dmc}{Assigning \x@fch@r\space as the follow-on column to #2 (in the #1 chain)}%
    \x@\xdef\csname f@llowing\x@fch@r\endcsname{#1}\x@\global\x@\let\csname \x@fch@r isFolowOn\endcsname\tr@e
    \x@\xdef\csname f@llow@n#2\endcsname{\x@fch@r}%
    \x@\xdef\csname f@llow@n\x@fch@r\endcsname{}%
    \let\n@xt\sw@llowtwo
  \else
    \advance\count255 -1
    \edef\x@fch@r{\@Alph{\count255}}%
    \let\n@xt\@new@followon
  \fi
  \n@xt{#1}{#2}%
}
\def\cle@rf@llow@ns#1{
  \x@\let\csname f@llow@n#1\endcsname\empty
  \x@\global\x@\let\csname layout@#1\endcsname\empty
  \x@\global\x@\def\csname @max@cols@#1\endcsname{0}
  \x@\global\x@\let\csname f@llows#1\endcsname\empty
  \cle@rtmpnum{#1}%
}
\def\cle@rtmpnum#1{%
  \x@\global\x@\def\csname @tmpnum@#1\endcsname{0}%
}
\def\polyglot@eachtime@setup@complexpages{%
  \ifx\diglot@list\empty\else
    \let\col@do\cle@rf@llow@ns\x@\each@col\diglot@list\E% Stop all chains.
  \fi
}

\def\reset@colindexes{%
  \ifx\diglot@list\empty\else
    \let\col@do\cle@rtmpnum\x@\each@col\diglot@list\E% reset column counts
  \fi
}

\newcount\p@lyr@wno
%%%%%%%%%%%%%%%%%%%%%%%%% code that needs slash to not be active.  
\catcode47=\tw@lve

  \def\sstackup#1/#2\E{\edef\sstack@tmp{#2}\ifx\sstack@tmp\empty\let\n@x=\sstackrelax\else\let\n@x=\sstackup\fi\n@x #2\E\edef\sstack@tmp{#1}\ifx\sstack@tmp\empty\else\d@@ #1\E\fi}                  %(1)
  \def\sstackdown#1/#2\E{\edef\sstack@tmp{#1}\ifx\sstack@tmp\empty\else\d@@ #1\E\fi\edef\sstack@tmp{#2}\ifx\sstack@tmp\empty\let\n@x=\sstackrelax\else\let\n@x=\sstackdown\fi\n@x #2\E}
  \def\sstackrelax#1\E{}
    
  \def\complexs@tpolyp@ges#1\E{%page processing
    \p@lyr@wno=0
    \let\d@@\@complexs@tpolyp@ges
    \sstackdown#1/\E
    \global\advance\p@lyp@geno by 1
  }
  \def\complexr@vpolyp@ges#1\E{%reverse processing
    \p@lyr@wno=0
    \let\d@@=\@complexr@vpolyp@ges % Do the mirrored-version
    \sstackdown#1/\E
    \global\advance\p@lyp@geno by 1
  }
  \def\complexcheck@polyp@ges#1\E{
    \p@lyr@wno=0
    \let\d@@\@complexcheck@polyp@ges
    \sstackdown#1/\E
    \global\advance\p@lyp@geno by 1
  }
    
\catcode47=\active
%%%%%%%%%%%%%%%%%%%%%%%%%

\def\inactive@col@code#1{\x@\let\csname in@ctive@col@#1\endcsname\tr@e}% Various 'column codes' are not connected to any input. Use ifcsname to check for them
\inactive@col@code{-} % A blank column
\inactive@col@code{=} % Lines
%\inactive@col@code{+} % Footnote slot?
%\inactive@col@code{@} % Image / sidebar slot??

\def\col@active@count#1{\ifcsname in@ctive@col@#1\endcsname\else\advance\count255 by 1 \fi}% 
\def\@@complexr@vpolyp@ges#1{%
 % \tracingmacros=1 
  %\trace{dmc}{  @@complexr@vpolyp@ges #1}%
  %\tracingcommands=1 
  %\tracingassigns=1
  \count255=\csname @tmpnum@#1\endcsname
  \advance\count255 by 1
  \edef\@tmpnam{decode@#1\the\count255}%
  \x@\let\x@\x@fch@r\csname \@tmpnam\endcsname
  \trace{dmc}{... #1\the\count255 \space is \x@fch@r}%
  \xdef@cseq{@tmpnum@#1}{\the\count255}%
  \ifBookOpenLeft
    \xdef@cseq{p@lyp@gecols\p@lyp@gestring}{\x@fch@r\csname p@lyp@gecols\p@lyp@gestring\endcsname}%
  \else
    \xdef@cseq{revp@lyp@gecols\p@lyp@gestring}{\csname revp@lyp@gecols\p@lyp@gestring\endcsname\x@fch@r}%
  \fi
  %\tracingmacros=0 \tracingcommands=0 \tracingassigns=0
}
\def\@complexr@vpolyp@ges#1\E{%Row-of-columns processing
  \trace{dmc}{@complexr@vpolyp@ges #1, row=\the\p@lyr@wno}%
  \trace{dmc}{blank \ifBookOpenLeft rev\fi p@lyp@gecols\p@lyp@gestring}%
  \xdef@cseq{\ifBookOpenLeft \else rev\fi p@lyp@gecols\p@lyp@gestring}{}%
  \def\rev@tmp@list{}\def\list@type{tmp}%
  \let\col@do=\mkrev@list
  \edef\tmporder{#1}%
  \x@\each@col\tmporder\E
  \let\tmporder\rev@tmp@list
  \let\col@do\@@complexr@vpolyp@ges
  \trace{dmc}{@@complexr@vpolyp@ges \p@lyp@gestring {\tmporder}}%
  \x@\each@col\tmporder\E
  \ifBookOpenLeft
    \trace{dmc}{p@lyp@gecols\p@lyp@gestring\space is \csname p@lyp@gecols\p@lyp@gestring\endcsname}%
  \else
    \trace{dmc}{revp@lyp@gecols\p@lyp@gestring\space is \csname revp@lyp@gecols\p@lyp@gestring\endcsname}%
  \fi
  \advance\p@lyr@wno by 1 
}
\def\@complexs@tpolyp@ges#1\E{%Row-of-columns processing
  \count255=0
  \let\col@do\col@count
  \x@\each@col#1\E
  \edef\@cspptotcols{\the\count255}%
  \count255=0
  \let\col@do\col@active@count
  %\tracingmacros=1
  \x@\each@col#1\E
  \edef\@csppactcols{\the\count255}%
  \trace{dmc}{blank \ifBookOpenLeft rev\fi p@lyp@gecols\p@lyp@gestring}%
  \xdef@cseq{\ifBookOpenLeft rev\fi p@lyp@gecols\p@lyp@gestring}{}%
  \x@\xdef\csname cols@\p@lyp@gestring\endcsname{\the\count255}% active cols
  \edef\tmporder{#1}%
  \ifBookOpenLeft % In a book-open-left scenario, we need to process the page contents right-to-left. Easiest way to do that is reorder it from the start.
    \def\rev@tmp@list{}\def\list@type{tmp}%
    \let\col@do=\mkrev@list
    \x@\each@col\tmporder\E
    \let\tmporder\rev@tmp@list
  \fi
  \let\col@do\@@complexs@tpolyp@ges
  \x@\each@col\tmporder\E
  \ifBookOpenLeft
    \trace{dmc}{revp@lyp@gecols\p@lyp@gestring\space is \csname revp@lyp@gecols\p@lyp@gestring\endcsname}%
  \else
    \trace{dmc}{p@lyp@gecols\p@lyp@gestring\space is \csname p@lyp@gecols\p@lyp@gestring\endcsname}%
  \fi
  \global\advance\p@lyr@wno by 1
  \let\@cspptotcols\undefined
  \let\@csppactcols\undefined
}

\def\@complexcheck@polyp@ges#1\E{%Check for Row-of-columns processing
  \edef\tmp{#1}%
  \edef\tmpnam{\checkmode p@lyp@gecols\p@lyp@gestring}%
  \edef\tmpval{\csname \tmpnam\endcsname}
  \trace{dmc}{\tmpval=\tmp ?}
  \ifx\tmpval\tmp
  \else
    \edef\checkreport{\checkreport\tmpnam\space does not agree (\tmpval!=#1) }%
  \fi
  \global\advance\p@lyr@wno by 1
}
\def\p@lyp@gestring{\the\p@lyp@geno-\the\p@lyr@wno}
\def\p@lyp@gesuffx{@poly@\p@lyp@gestring}

\def\@@complexs@tpolyp@ges#1{%column processing
  \traceifset{@@cspp}%
  \ifcsname #1isDiglotColumn\endcsname
    \edef\x@fch@r{#1}% The expanded field char.
    \x@\let\x@\@@cspptmp\csname @max@cols@#1\endcsname
    %\trace{dmc}{#1 @@cspptmp \meaning\@@cspptmp}%
    %\ifx\@@cspptmp\z@ro \message{@@cspptmp is not zero}\fi
    \ifnum \@@cspptmp =0 % This must be the first occurance
      \ifnum\@csppactcols>1 \x@\let\csname layout@#1\endcsname\gr@dnormal % Normal 
      \else\x@\let\csname layout@#1\endcsname\gr@dnone \fi % No sync
    \else
      \new@followon{#1}%
      \x@\let\csname layout@#1\endcsname\gr@dnone % No sync
    \fi
    \ifnum\@@cspptmp <\@cspptotcols
      \x@\xdef\csname @max@cols@#1\endcsname{\@cspptotcols}%Used in determining the column width.
    \fi
    \x@\let\x@\@@cspptmp\csname @max@cols@#1\endcsname
    \ifBookOpenLeft
      \xdef@cseq{revp@lyp@gecols\p@lyp@gestring}{\x@fch@r\csname revp@lyp@gecols\p@lyp@gestring\endcsname}%
    \else
      \xdef@cseq{p@lyp@gecols\p@lyp@gestring}{\csname p@lyp@gecols\p@lyp@gestring\endcsname\x@fch@r}%
    \fi
    \count255=\csname @tmpnum@#1\endcsname
    \advance\count255 by 1
    \edef\@tmpnam{decode@#1\the\count255}%
    \trace{dmc}{... #1\the\count255\space -> \x@fch@r}%
    \x@\xdef\csname \@tmpnam\endcsname{\x@fch@r}% L0->Z (etc) mapping, needed for reverse-order version
    \xdef@cseq{@tmpnum@#1}{\the\count255}%
  \else 
    \ifcsname inactive@col@code#1\endcsname\else
      \errmessage{!!! #1 is neither an inactive column code nor a diglot(polyglot) column. Define it first.}%
      \error%Force stop
    \fi
  \fi
  \traceifcheck{@@cspp}%
}
\def\checkpolypages{%
  \edef\sl@shcode{\the\catcode47}%
  \catcode47=\tw@lve\relax
  \@checkpolypages
}
\def\@checkpolypages#1#2{
  \p@lyp@geno=0
  \def\checkreport{}%
  \let\d@\complexcheck@polyp@ges
  \edef\checkmode{}%
  \edef\checknormal{#1}%
  \edef\checkrev{#2}%
  \x@\cstackdown\checknormal,\E
  \p@lyp@geno=0
  \edef\checkmode{rev}
  \x@\cstackdown\checkrev,\E
  \ifx\checkreport\empty\else
    \errmessage{\checkreport}%
  \fi
  \catcode47=\sl@shcode\relax
}

\def\trysplit#1{%
}

\def\polyglotpages@complexpages#1{%comma separated list of concatenated columns to put on different pages and rows (e.g. LR/A,B/C) specifies 2 pages, pg1 shows L, R and A, pg2 B and C.
  \trace{dmc}{polyglotpages #1}%
  \polyglot@onetime@setup
  \polyglot@eachtime@setup@complexpages
  \p@lyp@geno=0
  \edef\tmp{#1}%
  \ifx\tmp\empty\errmessage{polyglotpages called with empty argument. That's an error}\fi
  \let\d@=\complexs@tpolyp@ges
  \cstackdown#1,\E
  \reset@colindexes
  \p@lyp@geno=0
  \let\d@=\complexr@vpolyp@ges
  \cstackup#1,\E
  \catcode47=\sl@shcode\relax
  \catcode`\-=\d@shcode\relax
}

\def\polyglotpages{% Just in case, switch some catcodes.
  \edef\sl@shcode{\the\catcode47}%
  \edef\d@shcode{\the\catcode`\-}%
  \catcode47=\tw@lve % /
  \catcode`\-=\tw@lve \relax % -
  \polyglotpages@complexpages
}

\def\set@col@widths@complexpages{%
  \trace{d}{set@col@widths@complexpages}%
  \def\col@do##1{%
    \ifcsname inactive@col@code##1\endcsname\else
      \dimen0=\textwidth
      \count255=\csname @max@cols@##1\endcsname
      \advance\dimen0 by -\numexpr \count255 - 1\relax\gutter \relax\advance\dimen0 by -\count255\columnshift\relax
      \csname column##1width\endcsname=\csname Diglot##1Fraction\endcsname\dimen0
      \trace{dmc}{Set column width for ##1 to be \the\csname column##1width\endcsname}%
    \fi
  }%
  \x@\each@col\diglot@list\E
}
  
\plugin@endif
