%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007 by SIL International
% written by Jonathan Kew
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Paragraph style macros

% some flags used to communicate between the macros
\newif\if@ntromarker
\newif\if@ntro \newif\ift@tle \newif\ifb@dy \newif\ifNoBody
\newif\ifstartpara
\newif\ifintr@done\intr@donefalse % If true, then if@ntro can only be set between the start of a book and the first chapter number
\newif\ifReenterIntroOK\ReenterIntroOKtrue % If true, then a chapter number does not set intr@done

%+cpar_init
\def\initp@rastyles{\@ntrofalse \t@tlefalse \b@dyfalse \def\m@rker{p}\hsize=\textwidth}
%-cpar_init

% test if a marker is an "introduction" style (name begins with "i") and we're allowed to enter intro mode.
%+cpar_testintro
\def\t@stintro#1#2\relax{\ifnum 1=\if#1i \ifintr@done 0 \else 1 \fi \else 0\fi \global\@ntromarkertrue\else\global\@ntromarkerfalse\fi}
%-cpar_testintro

%+cpar_starttypes
% start title/intro/body, if not already in that mode, switching columns if needed
\def\st@rtintro{\TRACE{st@rtintro}\if@ntro\else
  \ifdiglot\else
    \ifnum\IntroColumns=\c@rrentcols\else
      \ifnum\IntroColumns=2 \doublecolumns\else\singlecolumn\fi
    \fi
  \fi
  \global\@ntrotrue\global\t@tlefalse\global\b@dyfalse\fi}

\def\st@rttitle{\TRACE{st@rttitle}\ift@tle\else
  \ifdiglot\else 
    \ifnum\TitleColumns=\c@rrentcols\else
      \ifnum\TitleColumns=2 \doublecolumns\else\singlecolumn\fi
    \fi
  \fi
  \global\t@tletrue\global\@ntrofalse\global\b@dyfalse\fi}

\newif\iftob@dy \tob@dyfalse
\def\st@rtbody{%\endhe@dings
 % \trace{o}{st@rtbody: b@dy\ifb@dy true\else false\fi}%
 \traceifset{st@rtbody}%
 \ifNoBody\else\ifb@dy\else\trace{o}{st@rtbody by \m@rker}%
%  \ifdiglot\else
%    \ifnum\BodyColumns=\c@rrentcols
%      \penalty-200\vskip\baselineskip
%    \else
      \tob@dytrue\ifnum\BodyColumns=2 \doublecolumns\else\singlecolumn\fi
%    \fi
%  \fi
  \tob@dyfalse
  \global\b@dytrue\global\@ntrofalse\global\t@tlefalse
  % set up for single column from single column. Empty vbox to say we are not at the start of a page
  \ifnum\BodyColumns=1 \onecolwidth{\hsize}\ifdim\ht\partial>\baselineskip\vbox{\kern0pt}\fi\fi
 \fi\fi
  \traceifcheck{st@rtbody}%
}

\newcount\c@rrentcols \global\c@rrentcols=1
%-cpar_starttypes

%
% Headings are set into a box, so that they can be measured and adjusted for the grid
%
%+cpar_endheadings
\newif\ifhe@dings
\newdimen\headingtopspace
\newbox\he@dingbox
\def\endhe@dings{\ifhe@dings\TRACE{endhe@dings}%
  \makecutouts \endgraf
  \egroup \cutoutcarryover
%{\showboxbreadth=200 \showbox\he@dingbox}
  \baselineskip=\onel@neunit%\s@tbaseline{p}{p}%
  \trace{h}{ht=\the\ht\he@dingbox dp=\the\dp\he@dingbox}%
  \ifdim\ht\he@dingbox>0pt \gridb@x\he@dingbox\fi\unvbox\he@dingnotes
  \global\he@dingsfalse
  \global\first@fterheadingtrue
 \fi
}
\newif\iffirst@fterheading
%-cpar_endheadings

%+cpar_killdescenders
\def\killd@scenders#1{%
  \vbox{%
  \trace{h}{killing descenders: ht=\the\ht#1, dp=\the\dp#1}%
  \unvbox#1 \skip0=\lastskip\unskip \count255=\lastpenalty\unpenalty
    \setbox0=\lastbox\global\dimen4=\dp0  % Remember last box's depth
    \ifvoid0\else\dp0=0pt \box0 \fi
    \trace{h}{+skip=\the\skip0, depth=\the\dimen4}%
    \ifdim\skip0>0pt \penalty\count255 \vskip\skip0 \fi}%
}
%-cpar_killdescenders

%
% Given a box of headings, output it but ensure we use an integral number of lines altogether
%
%+cpar_gridbox1
\def\gr@db@x#1{%
% \setbox0=\vbox{\kern-#1pt \vrule\kern#1pt \kern-.4pt \box#1\kern-.4pt \vrule}%
\setbox0=\vbox{\unvbox#1}%\ifgridp@c\vbox{\box#1}\else\killd@scenders#1\fi%
\trace{h}{before gridbox: ht0=\the\ht0; dp0=\the\dp0 (dp was \the\dimen4)}%
%\MSG{after killd: ht0=\the\ht0; dp0=\the\dp0}
%{\showboxbreadth=100 \showboxdepth=10 \showbox0 }%
 \dimen2=\ht0 \advance\dimen2 by \dp0
 %\dimen0=\ifnum\@djustment>0 -\baselineskip\else0pt \fi
 \dimen0=0pt
 \ifgridp@c\line{}\nobreak\fi % otherwise first \line in loop won't get any baselineskip
                              % when doing a picture box, because it's not part of the
                              % current page
 \loop \ifdim\dimen0<\dimen2                                                    %(1)
   \advance\dimen0 by \baselineskip
   \line{}\nobreak \repeat
 \setbox0=\vbox to 0pt{\kern-\ht0\unvbox0}%
 \trace{h}{after gridbox: dimen0=\the\dimen0; dp0=\the\dp0}%
 \unvbox0 \nobreak
}
\newif\ifgridp@c % if applying \gridb@x to a picture box rather than headings
%-cpar_gridbox1

%+cpar_gridbox2
% returns in \dimen0 how much to advance \dimen1 to be an integral multiple of \dimen0
% \dimen1 ends up rounded down to an integral number of input \dimen0
\def\m@d{\dimen3=\dimen1\divide\dimen1\dimen0\multiply\dimen1\dimen0\advance\dimen3 by -\dimen1\advance\dimen0 by -\dimen3}

\def\gr@db@@x#1{%
  \ifdim\baselineskip < 0.5pt \unvbox#1
  \else
      \ifhmode\endgraf\lastdepth=\prevdepth\fi % Not sure why, but sometiems we get here in hmode
      \prevdepth=0pt
      % \setbox0=\ifgridp@c\vbox{\box#1}\else\killd@scenders{#1}\fi
      \setbox0=\vbox{\box#1}%
      \trace{h}{after killingdescenders: ht=\the\ht0, dp=\the\dp0}
      \ifVisTraceExtra
        \setbox0=\vbox{\box0\doVisTraceT{G}\box0}%
      \fi
	  \ift@tle\lastdepth=0pt \fi
      \trace{h}{before gridbox: ht0=\the\ht0; dp0=\the\dp0; spacebefore=\the\headingtopspace; lastdepth=\the\lastdepth}%
      \baselineskip=\onel@neunit%\s@tbaseline{p}{p}
      \dimen1=\ht0 \dimen0=\baselineskip \m@d \dimen2=\dimen0 % dimen2 is grid space
      \dimen1=\ht0 \advance\dimen1 by -\headingtopspace
      \dimen0=\baselineskip \m@d \advance\dimen2 by -\dimen0
      \advance\dimen2 by \headingtopspace                                           %(1)
      \ifgridp@c\else\ifdiglot\else
        \ifdim\lastdepth>0pt \advance\dimen2 by -\lastdepth\fi
      \fi\fi
      \ifdiglot\kern\else\vskip\fi\dimen2
      \trace{h}{after gridbox(\ch@pter.\v@rse): skip \the\dimen2, kern \the\dimen0; baselineskip=\the\baselineskip; dim1=\the\dimen1;  ht0=\the\ht0; dp0=\the\dp0; is \ifdiglot\else\space not\fi\space diglot}%
      \vbox{\kern\dimen0\vskip-\headingtopspace\unvbox0}%
      \nobreak%\dimen0=\prevdepth\trace{h}{prevdepth=\the\dimen0}%
  \fi
}

\newif\ifsquashgridbox\squashgridboxtrue                                        %(2)
\let\gridb@x\gr@db@@x % overridden during \ptxfile setup, depending on \ifdiglot and \ifsquashgridbox 
%-cpar_gridbox2

\def\at@ndofthispar{}
\def\at@ndofthisparR{}
\def\at@ndofthisparL{}
\def\at@ndofthisparDelay{}
\def\at@ndofthisparRDelay{}
\def\at@ndofthisparLDelay{}
\ifcsname ForcedLooseness\endcsname\else\gdef\ForcedLooseness{}\fi

\newif\ifdoingt@ble
\newdimen\lastdepth
%+cpar_par
% end a paragraph, handling cutouts (shaping around drop-cap) if any, and the <end> hook
\def\par{\ifhmode
   \makecutouts
   \cl@singhooks{end}{\m@rker}%
   \ifx\ForcedLooseness\empty\else\looseness=\ForcedLooseness\fi
   \trace{j}{hs=\the\hsize, bs=\the\baselineskip, loose=\the\looseness, ls=\the\leftskip, rs=\the\rightskip, pf=\the\parfillskip par after \m@rker (\styst@k)}%
   \ifdoingt@ble\else
     \ifx\styst@k\empty% If we have an empty stystack, then should we do nothing or fall back to using m@rker? it seems to be anomalous
       %\s@tsideskips{\m@rker}% 
     \else
       \s@tsideskips{\styst@kfirst}%%Need this for when \everypar gets fired from within a group. (e.g. from a trigger or milestone)
     \fi
   \fi
   \endgraf
   \ifvmode\ifinn@te\else\ifhe@dings\else\ifdoingt@ble\else\lastdepth=\prevdepth\fi\fi\fi\fi
   \ifinn@te\else\ifdoingt@ble\else
     \edef\t@mpp{\string\@parlen{\lastc@rref}{\lastc@rradj}{\the\prevgraf}}\x@\write\x@\p@rlocs\x@{\t@mpp}%
   \fi\fi
   \cutoutcarryover 
 \fi
 \do@ndofthispar
}
%-cpar_par
% No blank line here!
%+cpar_doendofthispar
\def\do@ndofthispar{%
 %run code to insert picb@x / picb@xR at the right time.
 \edef\eotpn@me{at@ndofthispar\c@rrdstat}% Which endofthispar macro?
 \x@\let\x@\pn@xt\csname \eotpn@me\endcsname
 \trace{g}{doendofthispar \ch@pter:\v@rse\c@rrdstat \space \the\pagetotal,
           \the\holdinginserts, page/chunk-\ifp@gestart start\else -middle\fi}%
 \temptrue %If iftemp stays true, then it's a valid insertion point.
 \ifx\pn@xt\empty\tempfalse\fi
 \ifinn@te\tempfalse\fi %No pictures in notes!
 \ifdiglot
   \ifp@gestart\tempfalse\fi
 \else 
   \ifdim\pagetotal=0pt \tempfalse\fi
 \fi
 \ifx\pn@xt\empty\else
   \iftemp
     %Potential inclusion location. Check delay.
     \edef\temp{\csname\eotpn@me Delay\endcsname}%
     \ifx\temp\empty\else
       \let\pn@xt=\empty
       \trace{g}{\ch@pter:\v@rse. Delayed by specification (\temp)}%
       \x@\shrinkdel@y \temp\EDLY\relax
       \trace{g}{Delay for \eotpn@me set to \temp}%
       \x@\xdef\csname \eotpn@me Delay\endcsname{\temp}%
       \edef\eotpn@me{empty}%
     \fi
   \else
     \edef\eotpn@me{empty}%
     \let\pn@xt=\empty
     \trace{g}{\ch@pter:\v@rse. Not here}%
   \fi
 \fi
 \ifx\pn@xt\empty\else
   % Time to acually include the picture
   \trace{g}{\eotpn@me\space used (\the\holdinginserts)\the\ht\picb@x / \the\ht\picb@xR}%
   %\nonstopmode
   %\show\pn@xt
   %\edef\pn@xt{\hbox{x}}% test code
   \x@\global\x@\let\csname\eotpn@me\endcsname=\empty
   \pn@xt\relax 
 \fi
}

\def\shrinkdel@y#1|#2\EDLY{\trace{g}{shrink {#1}{#2}}\xdef\temp{#2}}
%-cpar_doendofthispar

%
% Handle a paragraph style marker (parameter is the marker name)
%
%+cpar_parstyle_intro
\newif\ifhe@dingstyle
\newif\ifnsp@cebefore
\newif\ifJustifyPars \JustifyParstrue
\def\introAmbigious#1{\x@\def\csname intro@mbigious-#1\endcsname{t}}
\def\settest@mb#1{\x@\let\x@\test@mb\csname intro@mbigious-#1\endcsname}
\introAmbigious{iex} % iex can be intro or not intro.

\newcount\dropped@ther@lines
\dropped@ther@lines=0
\def\endit@P{%Called by whileitp@ps, to end a paragraph style
 \let\p@r=\par % end the paragraph
 \ifhmode\unskip % remove any trailing space
   \beginL\pdfsavepos
   \write\p@rlocs{\noexpand\@parend{\the\pdflastxpos}{\the\pdflastypos}}\endL       %(1)
   %\ifnum\pagetracing>0\tracingparagraphs=1\ifnum\pagetracing>1\looseness=-1%\emergencystretch=1sp
   %  \fi\else\tolerance=10\fi
   \p@r
   \ifvmode
    %\ifdim\prevdepth>0pt \lastdepth=\prevdepth\else\lastdepth=-1pt \fi
   \else
     %\lastdepth=0pt
     \ifinner\trace{sa}{Inner mode at end of paragraph style \m@rker}\fi
   \fi
   \trace{C}{enditP: \the\dropped@ther@lines, \ifdr@ppednumber dropped num\fi, \pending@items}%
   \ifnum\pagetracing>0\tracingparagraphs=0\fi
   \ifnum 0\ifdr@ppednumber 1\else\ifnum\dropped@ther@lines>0 1\fi\ifx\pending@items\cstackempty\else1\fi\fi>0 % the preceding par had a dropped number or other cutout;                       %(2)
                    % add \nobreak if it was a single line, else clear the flag
     \x@\write\x@\p@rlocs\x@{\x@\noexpand\x@\@parlines\x@{\the\prevgraf}}%
     \ifnum\prevgraf=1 \nobreak\else 
       \dr@ppednumberfalse 
       \ifnum\prevgraf<\dropped@ther@lines \nobreak
       \fi
     \fi
     \ifnum\dropped@ther@lines>0
       \advance\dropped@ther@lines by -\prevgraf
     \fi
   \fi
 \fi
 \mcpop
}

\def\writep@rstart#1{%Call with #1 = fully expanded baselineskip
   \beginL\pdfsavepos
   \write\p@rlocs{\noexpand\@parstart{#1}{\the\pdflastxpos}{\the\pdflastypos}}\endL
}

\newif\iftoplevelp@r
\def\endlastp@rstyle#1{%
 \getp@ram{spaceafter}{\m@rker}{\styst@k}% output any <spaceafter> for the  style active when the last paragraph ended.
 \global\let\spaceafterp@ram\p@ram
 \ifsk@pping \egroup \fi % if we were skipping nonpublishable text, end that mode
 \let\p@r=\par
 \the\p@rstylehooks % allow other modules to hook in here
 \end@llpoppedstyles{P}%
 \trace{s}{endlastp@rstyle #1 stack=\mcstack, stys@k:\styst@k}%
 \trace{ss}{endlastp@rstyle #1 stack=\mcstack}%
 \toplevelp@rtrue
 \def\d@##1+##2\E{\if##1P\relax\global\toplevelp@rfalse\let\d@=\cstackrelax\fi}%
 \mcdown
%-cpar_parstyle_intro
%+cpar_parstyle_after
 \t@stpublishability{#1}% test if the new marker is nonpublishable
 \ifn@npublishable
  \p@r% End the present paragaph, to make sure that cutouts, etc. are handled properly
  \setbox\j@nkbox=\vbox\bgroup\def\m@rker{#1}\sk@ppingtrue % and if so, start a box to consume and discard the text
 \else % else we need to actually process it!
  \ifx\m@rker\relax\else
    \ifx\spaceafterp@ram\relax \else
      \ifhe@dings\nobreak\fi
      \vskip\spaceafterp@ram\verticalsp@ceunit                                              %(1)
    \fi
    %\edef\spc@ut{pdf:code EMC}\x@\special\x@{\spc@ut}%
  \fi
  %\ifx\mcstack\mcstack@mpty\else
    %\def\d@##1+##2\E{\edef\tmp{##2}%
      %\ifx\tmp\m@rker\else\ifx\m@rker\relax\else\MSG{Bad closing marker "\tmp" expecting "\m@rker"}\fi\fi}%
  
    %\mctop \mcpop                                                                 %(2)
  %\fi
  \cl@singhooks{after}{\m@rker}%
  \the\afterh@@ks
 \fi
}

\def\s@tsideskips#1{% REMINDER: sideskips cannot be set globally, or a sidebar might change main-paragraph formatting.
   \ifx\styst@k\empty
      \edef\tmpstyst@k{#1}%
   \else
      \let\tmpstyst@k\styst@k
   \fi
   \getp@ram{glue}{#1}{\tmpstyst@k}%
   \ifx\p@ram\relax
     \def\gl@e{0.25\hsize}%
   \else
     \edef\gl@e{\p@ram\noexpand\hsize}%
   \fi
   % inside \beginR rightskip is leftskip and leftskip is rightskip!
   \parfillskip=0pt plus \gl@e 
   \ifRTL \rightskip\else\leftskip\fi =0pt
   \ifRTL \leftskip\else\rightskip\fi =0pt \ifJustifyPars\else plus \gl@e\fi
   \ifRTL\beginR\fi
   \getp@ram{justification}{#1}{\tmpstyst@k}%
   \ifx\p@ram\c@nter
    \leftskip=0pt plus \hsize \rightskip=\leftskip \parfillskip=0pt
   \else\ifx\p@ram\l@ft
    \ifRTL\leftskip\else\rightskip\fi=0pt plus \gl@e \ifRTL\parfillskip=0pt \fi
   \else\ifx\p@ram\r@ght
    \ifRTL\rightskip\else\leftskip\fi=0pt plus \gl@e \ifRTL\else\parfillskip=0pt \fi
   \fi\fi\fi
   \getp@ram{leftmargin}{#1}{\tmpstyst@k}%
   \ifx\p@ram\relax \else \advance \ifRTL\rightskip\else\leftskip\fi\p@ram \IndentUnit \fi
   \getp@ram{rightmargin}{#1}{\tmpstyst@k}%
   \ifx\p@ram\relax \else \advance \ifRTL\leftskip\else\rightskip\fi\p@ram \IndentUnit \fi
   \trace{j}{s@tsideskips #1 (\styst@k). \the\leftskip/\the\rightskip}%
}

\def\p@rstyle#1{\trace{ss}{p@rstyle: #1, onto stack: \mcstack}%
 \endlastp@rstyle{#1}%
 \ifn@npublishable\else
  \traceifset{p@rstyle}%
  \gdef\m@rker{#1}% remember the new style name
  \mcpushunderms{P}{#1}%
  \trace{s}{Pushed P+#1,  stack now: \mcstack [\styst@k]}%
  \op@ninghooks{before}{\m@rker}%
%-cpar_parstyle_after
  %
  % now we check what kind of marker this is: intro? title? section? other?
  % and switch to the appropriate mode
  %
%+cpar_parstyle_transition
  \let\styst@k=\empty
  \def\d@##1+##2+##3\E{\d@code{##1}{##2}\let\t@pstyle\tmp}\mctop
  \s@tstyst@k%
  \x@\t@stintro\m@rker\relax
  %If the marker is an (ultra-rare) type that occurs in introductions and normal text, then
  %set the intromarker flag based on what the current state (\if@ntro) is.
  \ifReenterIntroOK
    \settest@mb{\m@rker}\ifx\test@mb\relax\else
      \if@ntro\@ntromarkertrue\else\@ntromarkerfalse\fi 
    \fi
  \fi
  % \tr is treated as an intro marker if we're already in intro mode
  \if@tablerow\if@ntro\@ntromarkertrue\fi\fi
  \global\he@dingstylefalse
  \getp@ram{type}{\m@rker}{\m@rker}%
  \ifx\p@ram\t@tle
    \mark{\t@tle}\ifdiglot\marks\csname m@rknum\c@rrdstat\endcsname{\t@tle}\fi% 
    \ift@tle\else\ifhe@dings\endhe@dings\fi\fi
    \iftoplevelp@r\st@rttitle\fi
    \global\he@dingstyletrue 
  \else\ifx\p@ram\s@ction                                                       %(1)
    \ift@tle\ifhe@dings\endhe@dings\fi\fi
    \iftoplevelp@r \if@ntromarker\st@rtintro\else\st@rtbody\fi\fi
    \global\he@dingstyletrue
  \else\ifx\p@ram\oth@r
    \ift@tle\ifhe@dings\endhe@dings\fi\fi
    \iftoplevelp@r \if@ntromarker\st@rtintro\else\st@rtbody\fi\fi
    \if@ntromarker\else\global\he@dingstyletrue\fi
  \else
    \iftoplevelp@r \if@ntromarker\st@rtintro\else\st@rtbody\fi\fi
  \fi\fi\fi                                                                     %(2)
  \trace{H}{Marker type: \p@ram, stack: \mcstack [\styst@k] \space toplevel: \iftoplevelp@r True\else False\fi}%
  \ifhe@dingstyle\trace{sa}{headingstyle true}%
    \ifhe@dings\nsp@cebeforetrue\s@tbaseline{\m@rker}{\styst@k}%In a heading again, may be different so set a new baseline
    \else
        % Headingtopspace gets removed at top of page, preserve for titles.
        \getp@ram{spacebefore}{\m@rker}{\styst@k}\ifx\p@ram\relax\headingtopspace=0pt \else
          \ift@tle\headingtopspace=0pt \else
            \headingtopspace=\p@ram\verticalsp@ceunit
            %\trace{e}{hts: \the\headingtopspace, b@xadj:\b@xadj}%
            %\ifinextended 
              %\advance\headingtopspace by-\b@xadj
              %\vskip \b@xadj
            %\fi
        \fi\fi
        \setbox\he@dingbox=\vbox\bgroup\global\he@dingstrue
        \s@tbaseline{\m@rker}{\styst@k}% Obey baseline changes for headings
        \linepenalty=1000 % minimize line count
        \interlinepenalty=10000 % never break column/page between lines
        \XeTeXdashbreakstate=0 % mainly for ranges in \r
        \hyphenpenalty=10000 \exhyphenpenalty=10000 % don't hyphenate in headings
		\trace{h}{marker = \m@rker, spacebefore = \p@ram, heading top space = \the\headingtopspace}%
    \fi
    \nobreak
  \else\trace{sa}{headingstyle false}%
    \ifhe@dings\endhe@dings\fi
    \s@tbaseline{\m@rker}{\styst@k}%
  \fi
 \let\stylet@pe\ss@Para % Thus must come this late, or grouping gives odd results sometimes..
  \getp@ram{spacebefore}{\m@rker}{\styst@k}% output <spacebefore> for this style
  \ifx\p@ram\relax \else
    \ifhe@dings\nobreak\fi
    \ifnsp@cebefore\nsp@cebeforefalse\fi
	\vskip\p@ram\verticalsp@ceunit
  \fi
  \global\startparatrue
  \resetp@rstyle
%-cpar_parstyle_transition
  \p@rstyle@everypar{#1}%
  \traceifcheck{p@rstyle}%
 \fi}
%+cpar_parstyle_start

%Some user-supplied code may cause unwanted side-effects, e.g. to newch@rstyle 
\def\preservesettings{\let\epch@rstyle\newch@rstyle}
\def\restoresettings{\let\newch@rstyle\epch@rstyle}

\def\p@rstyle@everypar#1{%
  \trace{sP}{Redefined everypar}%
  \everypar={%
   \trace{sP}{everypar! ch@pter\g@tdstat waiting:'\csname ch@pter\g@tdstat waiting\endcsname'}%
   %
   % \everypar will be triggered when the paragraph actually starts (normally at the first character of text,
   % or something like a verse number); then we'll set up margins/indents and font
   %
   \preservesettings % Needed?
   \ifx\oldlinepenalty\relax\else
     \linepenalty=\oldlinepenalty
     \let\oldlinepenalty\relax
   \fi
   \the\@veryparhooks
   \restoresettings
   \x@\writep@rstart\x@{\the\baselineskip}%baselineskip must fully expanded as macro param, else it remains a macro and only L baseline is output on diglot/polyglot.
   %\edef\spc@ut{pdf:code /\c@rref \space BMC}\x@\special\x@{\spc@ut}%
   \ifdiglot\xdef\lastc@rref{\dc@rref}\else\xdef\lastc@rref{\id@@@ \ch@pter.\v@rse}\fi\xdef\lastc@rradj{\the\curr@djpar}%
   \s@tsideskips{\styst@kfirst}%Probably need this here in case the par gets ended e.g. by end of book.
   \trace{sa}{\m@rker\g@tdstat\space iu=\the\IndentUnit, ls=\the\leftskip, rs=\the\rightskip}%
   \getp@ram{fontsize}{\styst@kfirst}{\styst@k}\edef\c@rrfontsize{\ifx\p@ram\relax12\else\p@ram\fi}%Need to set this before calling s@tfont, else that will consder the current fontsize as ruling.
   \setwh@tvrstyle% set up font attributes (based on style stack)
   \trace{j}{baselineskip=\the\baselineskip ; UseGlyphMetrics=\the\XeTeXuseglyphmetrics}%
   \trace{o}{paragraph #1, hsize=\the\hsize}%
   \allowp@rindenttrue
   %
   % Generate top-level PDF bookmark if the \h book name has changed
   \pdfb@@kmark
   \getp@ram{firstindent}{\styst@kfirst}{\styst@k}\let\f@rstindent=\p@ram
%-cpar_parstyle_start
   %
   % handle drop-cap style chapter number, if this is the beginning of a chapter
   %
%+cpar_parstyle_chapter
   \ifinextended\else\x@\unless\x@\ifx\csname ch@pter\g@tdstat waiting\endcsname\relax
    \getp@ram{type}{\m@rker}{\m@rker}%
    \ifx\p@ram\v@rsetext
     \t@stpublishability{c}\ifn@npublishable
     \else
      \m@kechapterbox
      \ifRTL\let\c@tcmd=\rightcutout\else\let\c@tcmd=\leftcutout\fi
      \getp@ram{leftmargin}{\styst@kfirst}{\styst@k}%
      \ifx\p@ram\relax % simple case - no left indent
        \x@\c@tcmd\x@{\the\ch@pterwd}{0}{2}%
      \else % probably \q or something like that;                               %(1)
            % need to compare cutout width with leftindent
        \dimen0=\p@ram\IndentUnit \dimen2=\dimen0
        \ifx\f@rstindent\relax \else \advance\dimen0 by \f@rstindent\IndentUnit \fi
        % now \dimen0 is the real indent of the 1st line
        \dimen4=\ch@pterwd \advance\dimen4 by -\dimen0
        \ifdim\dimen4>0pt % if the chapter number doesn't fit there...
          \x@\c@tcmd\x@{\the\dimen4}{0}{1}% create extra indent
          \dimen4=\ch@pterwd \advance\dimen4 by -\dimen2 % and for wrap if needed
          \ifdim\dimen4>0pt \x@\c@tcmd\x@{\the\dimen4}{1}{1}\fi
        \else % the indent is already big enough, so just use it as is
          \setbox\ch@pterbox=\hbox to \dimen0{\box\ch@pterbox\hfil}%
        \fi
      \fi
      \x@\global\x@\let\csname ch@pter\g@tdstat waiting\endcsname\relax
      \ifIndentAtChapter\else \allowp@rindentfalse \fi
      \dr@ppednumbertrue
     \fi
     % generate second-level PDF bookmark for the chapter
     \pdfch@ptermark
    \fi
%-cpar_parstyle_chapter
%+cpar_parstyle_drop
   \else
    \ifdr@ppednumber % second line of chapter number, need to check indent/cutout
     \cancelcutouts % forget existing cutout, we're re-doing it
     \ifRTL\let\c@tcmd=\rightcutout\else\let\c@tcmd=\leftcutout\fi
     \getp@ram{leftmargin}{\styst@kfirst}{\styst@k}%
     \ifx\p@ram\relax % simple case - no left indent
       \x@\c@tcmd\x@{\the\ch@pterwd}{0}{1}%
     \else % probably \q or something like that;
           % need to compare cutout width with leftindent
       \dimen0=\p@ram\IndentUnit \dimen2=\dimen0
       \ifx\f@rstindent\relax \else \advance\dimen0 by \f@rstindent\IndentUnit \fi
       % now \dimen0 is the real indent of the 1st line
       \dimen4=\ch@pterwd \advance\dimen4 by -\dimen0
       \ifdim\dimen4>0pt % if the chapter number doesn't fit there...
         \x@\c@tcmd\x@{\the\dimen4}{0}{1}% create extra indent
       \else % the indent is already big enough, so just use it as is
       \fi
     \fi
     \dr@ppednumberfalse
     \spacefactor=\n@wchaptersf % prevent hanging verse number here
    \fi
   \fi\fi
   \run@pending
%-cpar_parstyle_drop
%+cpar_parstyle_final
   \ifx\f@rstindent\relax \else
    \x@\ifdim\f@rstindent pt<0pt
     \allowp@rindenttrue % redundant
    \else
     \iffirst@fterheading \ifIndentAfterHeading\else \allowp@rindentfalse \fi\fi
    \fi
    \ifallowp@rindent % create first-line indent, unless suppressed at dropped chapter number
                      % (note that we don't suppress negative indents, as in \q1 etc)
     \trace{Ds}{\m@rker\ifdiglot\c@rrdstat\fi\space  First indent \f@rstindent * \the\IndentUnit}%
     \kern\f@rstindent \IndentUnit                                              %(1)
    \fi
   \fi
   \ifvoid\ch@pterbox\else \kern-\wd\ch@pterbox \box\ch@pterbox \fi
   \global\p@ranesting=1
   \let\tmpn@xtparstart\n@xtparstart\gdef\n@xtparstart{}% Allow n@xtparstart to re-trigger itself
   \tmpn@xtparstart
   \op@ninghooks{start}{\m@rker}%handle <start> hook
   \ifdr@ppednumber \spacefactor=0\n@wchaptersf \fi
   % set special \spacefactor if we're at a chapter number, so \v 1 can omit the verse number here
   \startparafalse\first@fterheadingfalse
  }% end everypar
}
%-cpar_parstyle_final

%+cpar_pdfbookmark
\newif\ifRTL
\newif\ifallowp@rindent
\newif\ifdr@ppednumber
\newif\ifdr@ppedother
\dr@ppedotherfalse
\newif\ifIndentAtChapter
\newif\ifIndentAfterHeading \IndentAfterHeadingtrue
\newif\ifOmitVerseNumberOne \OmitVerseNumberOnefalse
\newif\ifOmitVerses \OmitVersesfalse
\newif\ifDropActions \DropActionsfalse
\def\n@wchaptersf{998}
\let\book\relax
\let\prevb@ok\relax
\let\bookR\relax
\let\prevb@okR\relax
\def\pdfb@@kmark{\ifdiglot\ifx\c@rrdstat\PDFBookMarkColumn\relax \pdfb@@km@rkD\fi\else\pdfb@@km@rk\fi}

\newif\ifActions \Actionstrue
\def\pdf@utline#1#2#3{%
% #1 dest id, #2 outline title, #3 outline level
  \ifActions
    \special{pdf:dest (#1) [@thispage /Fit]}%
    \special{pdf:outline #3 << /Title (#2) /A << /S /GoTo /D (#1) >> >>}%
  \else
    \special{pdf:outline #3 << /Title (#2) /Dest [@thispage /Fit] >>}%
  \fi
}

\def\pdfb@@km@rk{\trace{V}{pdfbookmark: \book \space after \prevb@ok}%
 \ifx\book\prevb@ok\else
  \global\dr@ppednumberfalse
  \ifDropActions\else\bgroup\liter@lspecials
    \ifx\book\relax \let\t@mp=\id@@@ \else \let\t@mp=\book\fi
    \ifrefbookmarks\let\t@mp=\id@@@\fi
    \pdf@utline{\id@@@.}{\t@mp}{0}%
    \global\let\prevb@ok\book\egroup\fi
 \fi}

\def\Alternative{\ /\ }%
\let\PDFBookMarkColumn=\relax
\let\b@okDiglot\empty

%Build a \Alternative separated list of book names 
\def\buildb@@k#1{\edef\bbtmp{#1}\x@\let\x@\t@st\csname b@ok\if L\bbtmp\else\bbtmp\fi\endcsname
  \ifx\t@st\relax\let\t@st\id@@@\fi
  \ifx\b@okDiglot\t@st\else 
    \ifx\b@okDiglot\empty\xdef\b@okDiglot{\t@st}\else\xdef\b@okDiglot{\b@okDiglot\Alternative\t@st}\fi
  \fi
}

\def\pdfb@@km@rkD{\ifDropActions\else
 %\tracingmacros=1
 %\tracingassigns=1
 \let\col@do\buildb@@k
 \let\b@okDiglot\empty
 \x@\each@col\diglot@list\E
 %\message{Bookname now: \b@okDiglot}%
 \ifx\b@okDiglot\prevb@okD\else
  \bgroup\liter@lspecials
   \pdf@utline{\id@@@.}{\b@okDiglot}{0}%
   \global\let\prevb@okD\b@okDiglot
  \egroup
 \fi\fi}
%-cpar_pdfbookmark

%+cpar_pdfchaptermark
\def\prevch@p{}
\def\pdfch@ptermark{\ifDropActions\else\ifdiglot\ifx\c@rrdstat\PDFBookMarkColumn\relax \pdfch@pterm@rk\fi
                                        \else\pdfch@pterm@rk\fi\fi}
\def\pdfch@pterm@rk{%
  \ifx\prevch@p\ch@pter\else
    \bgroup\liter@lspecials
    \edef\@@side{\g@tdstat}%
    \ifdiglot
      \let\t@mp\b@okDiglot
    \else
      \let\t@mp\book
    \fi
    \x@\let\x@\t@mp\csname book\@@side\endcsname
    \ifrefbookmarks\let\t@mp=\id@@@\fi
    \ifx\book\relax \let\t@mp=\id@@@ \fi
    \pdf@utline{\id@@@\@@side.\ch@pter}{\t@mp\space\ch@pter}{1}%
  \egroup\fi}

\newif\ifrefbookmarks
%-cpar_pdfchaptermark

%+cpar_initparlocs
\newwrite\p@rlocs
\newread\readp@rlocs
\def\initp@rlocs{%
  % check if there's a delayed-chapters file from a previous run
  \openin\readp@rlocs="\j@bname.delayed"
  \ifeof\readp@rlocs \let\n@xt\relax
  \else \def\n@xt{\input "\j@bname.delayed"}\fi
  \closein\readp@rlocs
  % and if so, read it so we'll use those settings
  \n@xt
  % open the parlocs file to record paragraph and no-break-chapter locations
  \immediate\openout\p@rlocs="\j@bname.parlocs"
}
\addtoinithooks{\initp@rlocs}
\def\locs@startstop#1#2{%
  %\showboxdepth=99
  %\showboxbreadth=99
  \let\old@ep=\everypar
  \everypar{}%
  \setbox#1\vbox{%
    %\hsize=\wd#1%
    \edef\dc@ref@rgs{\string\@colstart{\the\ht#2}{\the\dp#2}{\the\wd#2}}%
    \pdfsavepos
    \x@\write\x@\p@rlocs\x@{\dc@ref@rgs{\the\pdflastxpos}{\the\pdflastypos}}%
    \unvbox#1%
    \pdfsavepos
    \write\p@rlocs{\string\@colstop{\the\pdflastxpos}{\the\pdflastypos}}%
    %\MSG{\dc@ref@rgs (\the\hsize) ->}%
    }%
    %\MSG{\the\ht#1,\the\dp#1,\the\wd#1}%
    %\showbox#1
}
%-cpar_initparlocs

%+cpar_finishparlocs
\def\finishp@rlocs{%
  \immediate\closeout\p@rlocs
  \catcode`\{=1 \catcode`\}=2 \m@kedigitsother \catcode`\@=11
  \immediate\openout\delayf@le="\j@bname.delayed"
  %\tracingassigns=1
  \input "\j@bname.parlocs"
  \immediate\closeout\delayf@le
}
\newif\ifdelay@pen
\let\delayf@le=\p@rlocs % we write the delay file while reading the finished parlocs, so we can re-use the write stream
\addtoendhooks{\finishp@rlocs}
%-cpar_finishparlocs


% commands that get written to the parlocs file to record locations

%+cpar_parloccmds
%prev@y is the pdf y pos of the current paragraph
%this@y is the pdf y pos of the last line within the paragraph 
%thispar@lines is number of lines in the (recently finished) paragrpah
%
\newcount\prev@y \newcount\this@y \newcount\thing@y
\newcount\tmp@lines \newcount\thispar@lines
\newcount\p@rlinesgoneMonoglot
\let\p@rlinesgone\p@rlinesgoneMonoglot

\def\this@pgno{}
\def\par@items{,}   % \cstackempty but not defined yet
\x@\newif\csname ifinp@r-\endcsname

\def\calc@p@rlinesgone#1#2{%
  \ifcsname baselineskip@\c@rrdstat\endcsname
    \baselineskip=\csname baselineskip@\c@rrdstat\endcsname
  \fi
  \advance\p@rlinesgone by \numexpr \dimexpr #1 / \baselineskip \relax\relax
  \trace{C}{#2: ( #1  / \the\baselineskip) -> \the\p@rlinesgone}%
}

\def\@parstart#1#2#3{%
  \prev@y=#3\relax
  \dimen1=\numexpr \prev@col@y - \prev@y\relax sp\relax
  \edef\prev@col@ht{\the\dimexpr \tot@col@ht - \dimen1\relax}%
  \trace{C}{@parstart \tot@col@ht - \the\dimen1 = \prev@col@ht}%
  \csname inp@r-\c@rrdstat true\endcsname
  \x@\xdef\csname baselineskip@\c@rrdstat\endcsname{#1}\relax\p@rlinesgone=1\relax\let\par@items\cstackempty}

\def\@parend#1#2{%
  \this@y=#2\relax
  \calc@p@rlinesgone{\the\dimexpr \numexpr \prev@y-\this@y\relax sp\relax}{parend}%
  \csname inp@r-\c@rrdstat false\endcsname
}

\def\@parlen#1#2#3{}

\def\@nontextstart#1#2{\xdef\n@ntextstart{#2}}%
\def\@nontextstop#1#2{%
  \csname ifinp@r-\c@rrdstat\endcsname
    \ifcsname n@ntextstart\endcsname
      \dimen1=\dimexpr \n@ntextstart sp - #2 sp\relax
      \trace{C}{Non text for \n@ntextstart -#2 (=\the\dimen1)}%
      \edef\tot@col@ht{\the\dimexpr \tot@col@ht -\dimen1\relax}%
      \edef\prev@col@ht{\the\dimexpr \prev@col@ht -\dimen1\relax}%
  \fi\fi
}%

\def\@pgstart#1{%
  \edef\this@pgno{#1}}

\newif\ifp@rlengthimportant

\def\@@colstart#1#2#3#4#5{%
  \trace{C}{@colstart: \the\p@rlinesgone.}
  \edef\prev@col@x{#4}%
  \edef\prev@col@y{#5}%
  \prev@y=#5\relax
  \edef\tot@col@ht{\the\dimexpr #1 + #2\relax}%
  \let\prev@col@ht\tot@col@ht
  \edef\prev@col@wd{#3}%
  \p@rlengthimportantfalse
}
\@@colstart{0pt}{0pt}{0pt}{0}{0}
\def\@@colstop#1#2{%
  \edef\this@col@x{#1}%
  \edef\this@col@y{#2}%
  %\prev@y=#1
  \trace{C}{colstop:\c@rrdstat:\par@items}%
  \csname ifinp@r-\c@rrdstat\endcsname
    \calc@p@rlinesgone{\the\dimexpr \prev@col@ht\relax}{colstop}%
  \fi
  \let\d@=\check@pagefoot
  \x@\cstackdown\par@items\E
}
\def\@colstart#1#2#3#4#5{%
  \let\p@rlinesgone=\p@rlinesgoneMonoglot
  \@@colstart{#1}{#2}{#3}{#4}{#5}}
\def\@colstop#1#2{\def\c@rrdstat{}%%
  \@@colstop{#1}{#2}}
%Do somehing clever for items that are near 
%the end of the column.. Problem: the ones we're
%interested in doing clever things with were not put
%on the pending stack. Use a new stack, \par@items and
%...  Do somthing with it. At the moment just moan.
\def\check@pagefoot#1|#2|#3\E{%
  \ifnum #3 < \this@col@y
  \dimen1=\this@col@y sp
  \advance \dimen1 by -#3 sp
  \MSG{*** item type '#1' in cutout at #2 drops below the bottom of the column(by more than \the\dimen1)}%
  \fi
}

\def\@parlines#1{%
  \thispar@lines=#1
%  \MSG{* calculated \string\DelayedChapter{\pendingb@@k}{\pendingch@pter}{\the\this@y}}%
  %\ifx\pendingb@@k\empty\else
    %\ifdr@ppednumber
      %\wr@teDelayedChapter{\pendingb@@k}{\pendingch@pter}{\the\thispar@lines}%
      %\let\pendingch@pter\empty\let\pendingb@@k\empty
    %\fi
  %\fi
  \trace{C}{parlines: \the\thispar@lines =\the\p@rlinesgone?}%
  \ifnum \thispar@lines=\p@rlinesgone\else
    \ifp@rlengthimportant\let\tmp\MSG\else\let\tmp\message\fi
    \tmp{*** Mismatch between calculated and reported lines on page \this@pgno. Cutouts may not have been calculated properly}%
    \let\tmp\undefined
  \fi
  \ifx\pending@items\cstackempty\else
    \trace{C}{Before parlines: pending: \pending@items}%
   % \thispar@lines=\prev@y\advance\thispar@lines by -\this@y
   % \divide\thispar@lines by \baselineskip
    \def\D@IT{%
      %\tmp@lines=\thing@after
      \ifnum\thing@after>500\MSG{*** Rubbish data got into parlocs file.  \this@thing\space\thing@ref\space ignored}%
      \else
        \ifnum\thing@after>\thispar@lines
	  \MSG{*** \this@thing\space \thing@ref Is supposed to be delayed by \thing@after lines, but paragraph is \the\thispar@lines long}%
	  \tmp@lines=\thing@after
	  \advance\tmp@lines by -\thispar@lines
	  \edef\thing@after{\the\tmp@lines}%
	  \add@pending{\this@thing}{\thing@ref}{\the\this@y}{\thing@wd}{\thing@ht}{\thing@after}{\thing@side}%
      %\this@y=#2\relax
      %\ifnum\thing@y=0% First time. Don't adjust anything
        \else
          \ifnum\thing@y<\this@y
            \MSG{*** unable to determine \string\DelayedItem\space setting for \this@thing/\thing@ref (\the\thing@y, \the\this@y), removed from list}%
          \else
            \tmp@lines=\thing@y
            \advance\tmp@lines by -\this@y
            \divide\tmp@lines by \baselineskip
	    \advance\tmp@lines by \thing@after
	    \MSG{\this@thing \thing@ref [ \thing@after=>\the\tmp@lines]}%
	    \add@pending{\this@thing}{\thing@ref}{\the\this@y}{\thing@wd}{\thing@ht}{\thing@after}{\thing@side}%
          \fi
	\fi
      \fi
    }%
    \let\d@=\parse@pending
    \let\tmp\pending@items
    \global\let\pending@items\cstackempty
    \x@\cstackup\tmp\E
    \trace{C}{After parlines: pending: \pending@items}%
  \fi
  \let\n@xtline=\relax
  \trace{C}{Pending: \pending@items}%
  \ifx\pending@items\cstackempty\else
    \let\d@=\write@pending
    \x@\cstackdown\pending@items\E
  \fi
}
%-cpar_parloccmds

%+cpar_delayedchap
%\def\@delayedchapter#1#2#3#4{\chap@y=#4\relax
  %\ifnum\prev@y<\chap@y % para start was lower than chapter number, must have passed a col/page break
    %\def\pendingb@@k{#1}%
    %\def\pendingch@pter{#2}%
  %\else % para start level with or above chapter number; OK to calculate # of lines
    %\advance\prev@y by -\chap@y
    %\divide\prev@y by \baselineskip
    %\MSG{* calculated \string\DelayedChapter{#1}{#2}{\the\prev@y}}%
    %\wr@teDelayedChapter{#1}{#2}{\the\prev@y}%
  %\fi}

\def\@delayedchapter#1#2#3#4{% Part of post-run processing
  \trace{C}{delayedchapter #1 #2 #3 #4}%
  \@delayedthing{chapter}{#1#2.0}{#4}{\the\ch@pterwd}{2}{0}{\ifRTL R\else L\fi}{#3}{#4}}

% @delayedthing
% #1 - type-code (determines flexibility of position
% #2 - Reference trigger point
% #3 - ?
% #4 - cutout width  (pt)
% #5 - cutout length (lines)
% #6 - Cutout delay
% #7 - cutout side
% #8 - pdfpos X
% #9 - pdfpos Y
\def\@delayedthing#1#2#3#4#5#6#7#8#9{%Part of post-run processing
  \thing@y=#9\relax 
  \ifcsname baselineskip@\c@rrdstat\endcsname
    \baselineskip=\csname baselineskip@\c@rrdstat\endcsname
  \fi
  \trace{C}{delayedthing (prev:\the\prev@y) #1 #2 #3 #4 #5 #6 #7 #8 #9, bl:\the\baselineskip}%
  %\ifnum\the\prev@y<\thing@y % Lower number means lower on page. para start was lower than chapter number, must have passed a col/page break
    %%\def\this@thing{#1}% What is it?
    %\def\thing@ref{#2}% Unique id.
    %\trace{C}{* saved pending  \string\DelayedItem{#1}{#2}}%
    %\add@pending{#1}{#2}{\the\thing@y}{#4}{#5}{#6}{#7}%
  %\else % para start level with or above chapter number; OK to calculate # of lines
    %
    %First, remember where the bottom of the item probably is.
    \tmp@lines=\thing@y
    \trace{C}{\the\tmp@lines}% 
    \dimen1=\dimexpr #5 \baselineskip\relax %how many lines the item is
    \trace{C}{... -\the\dimen1}% 
    \advance\tmp@lines by -\dimen1
    \dimen1=#6 \baselineskip % delay of the item
    \trace{C}{... -\the\dimen1}% 
    \advance\tmp@lines by -\dimen1
    \xdef\par@items{\cstackpush{\par@items}{#1|#2|\the\tmp@lines}}% Add end-point to stack checking.
    \tmp@lines=\prev@y
    \advance\tmp@lines by -\thing@y
    \divide\tmp@lines by \baselineskip
    \advance\tmp@lines by #6
    \advance\tmp@lines by \p@rlinesgone
    \advance\tmp@lines by -1 % starting on 1st line is 0, not 1.
    \trace{C}{* calculated \string\DelayedItem{#1}{#2}{\the\tmp@lines} (#4 x#5 @#6)}%
    %\add@pending{#1}{#2}{\the\thing@y}{#4}{#5}{\the\tmp@lines}{#7}%
    \ifnum\tmp@lines>3 \p@rlengthimportanttrue\fi
    \wr@teDelayedItem{#1}{#2}{\the\tmp@lines}{(#4x#5@#6)#7}%
  %\fi
}

%-cpar_delayedchap

%+cpar_writedelayed
\def\setCutoutSlop#1#2#3{\x@\xdef\csname raiselimits-#1\endcsname{#2,#3}}
\def\setCutoutSlopDefault#1#2{\xdef\defaultSlop{#1,#2}}
\setCutoutSlop{chapter}{1}{0} % Up,Down
\setCutoutSlopDefault{2}{1}% 2 up, 1 down
\def\@@getCutoutSlop#1{\x@\let\x@\r@iselimit\csname raiselimits-#1\endcsname}%
\def\g@tCutoutSlop#1{\@@getCutoutSlop{#1}\ifx\r@iselimit\relax\x@\p@rselimit\defaultSlop\E\else\x@\p@rselimit\r@iselimit\E\fi}
\def\p@rselimit#1,#2\E{\edef\@djustmin{-#1}\edef\@djustmax{#2}}

\def\wr@teDelayedItem#1#2#3#4{% Part of post-run processing
  %\wr@teDelayedItem{thingtype}{curref}{delay}{cutout wd}{cutout ht}{cutout after}{cutout side}%
  \def\c@rref{#2}%
  \trace{C}{wDI}%
  \delay@test{#1}% 
  \raise@test{#1}%
  \ifx\t@std@lay\relax \pr@vdelay=0 
  \else \pr@vdelay=\t@std@lay\fi
  \th@sdelay=#3\relax % Delay calculated here
  \ifnum\pr@vdelay=\th@sdelay % if the delay value is unchanged, all is good
    \ifx\t@str@ise\relax
      \trace{C}{PARLOC:ok}%
    \else
       \ifnum\t@str@ise=0\else
         \MSG{PARLOC: Rerun. RaiseItem was applied for #1 #2, but not needed}%
       \fi
    \fi
  \else
    \tmp@lines=\pr@vdelay
    \advance\tmp@lines by -\th@sdelay % Negative if the image/chapnum is going up, +ve if going down
    %\ifx\t@str@ise\relax \else \count255=\t@str@ise\advance\tmp@lines by -\count255\fi
    %\ifnum\tmp@lines <0 \count255=-\tmp@lines\else\count255=\tmp@lines\fi
    \g@tCutoutSlop{#1}%
    \trace{C}{tmplines =\the\tmp@lines. OK if \@djustmin <= tmplines <=  \@djustmax}%
    \tempfalse
    \edef\@accept@djmin{\@djustmin}%
    \edef\@accept@djmax{\@djustmax}%
    \ifnum \tmp@lines<\@djustmin\relax 
      \edef\@accept@djmin{\the\tmp@lines}%
      \temptrue
    \fi
    \ifnum \tmp@lines>\@djustmax\relax 
      \edef\@accept@djmax{\the\tmp@lines}%
      \temptrue
    \fi  % if new delay is <2 away than old, we can use \RaiseItem
    \iftemp
      \MSG{PARLOC: Rerun. Delayed #1 setting changed (from \the\pr@vdelay to \the\th@sdelay) at #2.}
      \message{Current slop: \string\setCutoutSlop{#1}{\the\numexpr -\@djustmin\relax}{\@djustmax}}%
      \message{Would use RaiseItem if: \string\setCutoutSlop{#1}{\the\numexpr -\@accept@djmin\relax}{\@accept@djmax}}%
    \else
      \th@sdelay=\pr@vdelay % Retain past delay and (if needed) use raiseitem
      \multiply\tmp@lines by -1 % change sign to match semantics of raise.
      \ifx\t@str@ise\relax
        \ifnum\tmp@lines=0\else
          \ifx\t@std@lay\relax\else
            \MSG{PARLOC: Rerun. RaiseItem needed at #1 #2}%
            \temptrue
          \fi
        \fi
      \else 
        \ifnum\tmp@lines=\t@str@ise
          \ifnum\tmp@lines=0\relax\else % Need the same RaiseItem we had last time. 
            \trace{C}{PARLOC: OK.  RaiseItem still needed at #1 #2}%
            \temptrue
          \fi
        \else 
          \MSG{PARLOC: Rerun with new RaiseItem (by \the\tmp@lines was \t@str@ise) at #1 #2}%   
          \temptrue
        \fi
      \fi
      \iftemp
        \immediate\write\delayf@le{\string\RaiseItem{#1}{#2}{\the\tmp@lines}}%
      \fi
    \fi
  \fi
  \immediate\write\delayf@le{\string\DelayedItem{#1}{#2}{\number\th@sdelay}{#4}}%
}
\newcount\pr@vdelay \newcount\th@sdelay
\newif\ifsk@pping \newbox\j@nkbox
%-cpar_writedelayed

% Create the drop-cap in \ch@pterbox
%+cpar_makechapterbox
\newdimen\ch@pterwd
\newbox\ch@pterbox
\newbox\ch@pternote
\def\AfterChapterSpaceFactor{3}
\def\m@kechapterbox{%
 \trace{sP}{m@kechapterbox for \ch@ptert@xt, reftooltip\ifreftooltip true\else false\fi}%
 \edef\@seglyphmetrics{\the\XeTeXuseglyphmetrics}\XeTeXuseglyphmetrics=3%
 \edef\printchapter{\ch@ptert@xt}%
 \csname PrepChapterNumber\endcsname
 \setbox\ch@pterbox=\hbox{\s@tfont{c}{c}\printchapter}%
 \ifrotate
  \dimen0=1.0\ht\ch@pterbox
  \dimen1=\ht\ch@pterbox \advance\dimen1 by \dp\ch@pterbox\advance\dimen1 by \AfterChapterSpaceFactor\FontSizeUnit
  \dimen2=0.5\wd\ch@pterbox \advance\dimen2 by -0.5\ht\ch@pterbox
  \setbox\ch@pterbox=\hbox{\lower\dimen2\hbox to \dimen0{%
    \hskip\ht\ch@pterbox \special{x:gsave}\special{x:rotate 90}%
    \box\ch@pterbox\special{x:grestore}\hss}}%
  \ht\ch@pterbox=\wd\ch@pterbox\wd\ch@pterbox=\dimen1
 \else
  %\getp@ram{raise}{c}{\styst@k}%
  \getp@ram{raise}{c}{c+\styst@k}%
  \dimen0\baselineskip
  \trace{c}{Lowering by \the\dimen0 + \p@ram}%
  \ifx\p@ram\relax\else\advance\dimen0 by -\p@ram\fi
  \setbox\ch@pterbox=\hbox{\lower\dimen0\box\ch@pterbox
    \box\ch@pternote\kern\AfterChapterSpaceFactor\FontSizeUnit}%
 \fi
 \XeTeXuseglyphmetrics=\@seglyphmetrics
 \ch@pterwd=\wd\ch@pterbox
 \dp\ch@pterbox=0pt
}
%-cpar_makechapterbox

\newif\ifreftooltip
\def\ch@ptooltipstart{\special{pdf:bann << /Type /Annot /Subtype /Widget /H /N /TU (\id@@@ \space \ch@pter :\v@rse) /T (tooltip \id@@@ \ch@pter :\v@rse) /C [] /FT /Btn /F 768 /Ff 65536 /BS << /W 0 >> >>}}
\def\ch@ptooltipend{\special{pdf:eann}}

%+cpar_ptxnb
% Used to delay a cutout until later in the paragraph, for no-break chapter numbers
%\def\DelayedChapter#1#2#3{\uppercase{\def\ucb@@k{#1}}%
  %\x@\edef\csname delay-\ucb@@k.#2\endcsname{#3}}

\def\DelayedChapter#1#2#3{\uppercase{\def\ucb@@k{#1}}%
  \DelayedItem{chapter}{\ucb@@k.#2}{#3}{#2}}

%Param 3 is in lines.
\def\DelayedItem#1#2#3#4{%
  \x@\xdef\csname delay-#1.#2\endcsname{#3}\x@\xdef\csname delayparam-#1.#2\endcsname{#4}}

% Used to set a delayed paragraph number one line higher (projecting above the line with v.1 instead of below it)
%\def\RaiseChapter#1#2{\uppercase{\def\ucb@@k{#1}}%
  %\x@\let\csname raise-\ucb@@k.#2\endcsname=1}
\def\RaiseChapter#1#2{\uppercase{\def\ucb@@k{#1}}%
  \RaiseItem{chapter}{\ucb@@k.#2}{-1}}

\def\RaiseItem#1#2#3{%
  \x@\def\csname raise-#1.#2\endcsname{#3}}%

\def\delay@test#1{\x@\let\x@\t@std@lay\csname delay-#1.\c@rref\endcsname
  \trace{C}{delay@test: \id@@@\ifdiglot\c@rrdstat\fi.\ch@pter: #1 \c@rref ::\t@std@lay}}%

\def\raise@test#1{\x@\let\x@\t@str@ise\csname raise-#1.\c@rref\endcsname 
  \trace{C}{raise@test: \id@@@\ifdiglot\c@rrdstat\fi.\ch@pter: #1 \c@rref ::\t@str@ise}}%

\def\ptx@nb{%
  \x@\ifx\csname ch@pter\g@tdstat waiting\endcsname\relax
    \MSG{nb ignored near \ifdiglot\dc@rref\else\c@rref\fi: not after chapter}%
  \else
    \delay@test{chapter}%
    %\x@\let\x@\t@st\csname delay-\id@@@.\ch@pter\endcsname
    \ifx\t@std@lay\relax
      \MSG{*** no-break at \id@@@\ifdiglot \c@rrdstat\fi\space\ch@pter, re-run to generate \string\DelayedChapter\space setting}%
      \def\t@std@lay{0}%
    \else 
      \MSG{* no-break at \id@@@\space\ch@pter (\t@std@lay)}%
    \fi
    \leavevmode\str@t                                                           %(1)
    \x@\global\x@\let\csname ch@pter\g@tdstat waiting\endcsname\relax
    \t@stpublishability{c}\ifn@npublishable
     \setbox\ch@pterbox=\box\voidb@x
    \else
     \m@kechapterbox
     \setbox\ch@pterbox=\hbox{\box\ch@pterbox
       \kern\ifRTL\rightskip\else\leftskip\fi}%
     %\ifRTL\let\c@tcmd=\rightcutout\else\let\c@tcmd=\leftcutout\fi
     %\x@\c@tcmd\x@{\the\ch@pterwd}{\t@std@lay}{2}%
     \raise@test{chapter}%
     \ifx\t@str@ise\else\ifnum \t@str@ise=1
      \vadjust pre {\nobreak}% Prevent break before this line if the box is raised
     \fi\fi
     \vadjust{\vbox to 0pt{\kern-\dp\str@tbox \kern-\ht\ch@pterbox              %(2)
      \ifx\t@str@ise\relax \else \kern-\t@str@ise\baselineskip \fi
      \ifRTL\let\n@xt\rightline\else\let\n@xt\leftline\fi
      \n@xt{\ifRTL\beginR\fi\box\ch@pterbox\ifRTL\endR\fi}\vss}%
      \pdfb@@kmark\pdfch@ptermark\nobreak}%
     \beginL\pdfsavepos                                                         %(3)
     %\edef\dc@ref@rgs{\string\@delayedchapter\string{\id@@@\string}\string{\ch@pter\string}}%
     \ifdiglot\edef\@@ref{\id@@@\c@rrdstat}\else\edef\@@ref{\id@@@}\fi
     \edef\dc@ref@rgs{\string\@delayedchapter\string{\@@ref\string}\string{\ch@pter\string}}%
     \x@\write\x@\p@rlocs\x@{\dc@ref@rgs{\the\pdflastxpos}{\the\pdflastypos}}\endL
     \dr@ppednumbertrue
     \add@pending{chapter}{\ifdiglot\dc@rref\else\c@rref\fi}{0}{\the\ch@pterwd}{2}{\t@std@lay}{\ifRTL R\else L\fi}%
     \run@pending
    \fi
  \fi}

\newbox\str@tbox
\def\mkstr@t{\setbox\str@tbox=\hbox to 0pt{\XeTeXuseglyphmetrics=0                %(4)
  \char32 \hss}}
\def\str@t{\mkstr@t\copy\str@tbox}
%-cpar_ptxnb


%+cpar_resetparstyle
\def\resetp@rstyle{%
 \leftskip=0pt \rightskip=\leftskip
% \dimen0=\hsize \advance\dimen0 by -4em \parfillskip=2em plus \dimen0 minus 1em
 \parfillskip=0pt plus 1fil
 %\emergencystretch=11in
 \parindent=0pt }

%-cpar_resetparstyle

\endinput
